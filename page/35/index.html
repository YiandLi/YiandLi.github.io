<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":20,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="A slow learner.">
<meta property="og:type" content="website">
<meta property="og:title" content="Yili">
<meta property="og:url" content="http://example.com/page/35/index.html">
<meta property="og:site_name" content="Yili">
<meta property="og:description" content="A slow learner.">
<meta property="og:locale">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/35/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Yili</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yili</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Suggest Google Chrome for better math Reading.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/05/MySQL%20info/mysql%20DML/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/05/MySQL%20info/mysql%20DML/" class="post-title-link" itemprop="url">mysql DML Data Manipulation Language</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-05 21:46:54" itemprop="dateCreated datePublished" datetime="2021-03-05T21:46:54-08:00">2021-03-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>DML (Data Manipulation Language) 数据操作语言<br />
数据操纵分成  <strong>数据查询</strong>  和 <strong>数据更新</strong> 两类。数据更新又分成 <strong>插入、删除、和修改</strong> 三种操作。<br />
<strong>mysql一共有7个查询命令：FROM，SELECT，WHERE，GROUP BY，HAVING，ORDER BY，LIMIT</strong></p>
<h3 id="查询命令和临时表"><a class="markdownIt-Anchor" href="#查询命令和临时表"></a> <strong>查询命令和临时表</strong></h3>
<ol>
<li>每一个查询命令在执行时，都是在操作上一个命令生成的临时表。</li>
<li>每一个命令执行完毕后，Mysql服务器自动在内存中销毁上一个查询命令生成的临时表。所以，用户只能看到最后一个查询命令生成的临时表。</li>
<li>只有<code>FROM</code>命令不需要操作临时表。</li>
<li>只有<code>GROUP BY</code>命令在执行完后有机会生成多个临时表。</li>
<li>只有<code>HAVING</code>命令在执行完毕后，不会生成新的临时表。负责将<code>GROUP BY</code>命令生成的临时表中不满足的临时表从内存中删除。</li>
</ol>
<h3 id="from命令"><a class="markdownIt-Anchor" href="#from命令"></a> <strong>FROM命令</strong></h3>
<ol>
<li>永远是第一个执行的查询命令，负责将硬盘上的表文件加载到内存中生成<strong>临时表</strong>供后续查询命令使用。所以，执行查询命令时，是不会修改文件原来的数据的。</li>
<li>临时表的名称与硬盘上的表文件名称保持一致。</li>
</ol>
<h3 id="select命令"><a class="markdownIt-Anchor" href="#select命令"></a> <strong>SELECT命令</strong></h3>
<ul>
<li>语法：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT [DISTINCT] 字段1 [[AS] 别名1], 字段2 [[AS] 别名2] ... FROM 表名;</span><br></pre></td></tr></table></figure>
<p><code>DISTINCT</code> 去除重复记录，用于字段之前，可以用在select，聚合函数内部 。<br />
<code>AS</code>是设置别名，增强可读性，<code>AS</code> 也是可以省略的。</p>
<ol>
<li>操作的是由FROM命令生成的临时表。</li>
<li>会像切蛋糕一样，将指定字段下所有的数据读取出来，在内存中将读取的数据组成一个全新的临时表。</li>
<li>完成SELECT命令之后，服务器会返回SELECT建立的临时表，并且销毁FROM建立的临时表。</li>
<li>如果临时表由FROM和WHERE提供，则SELECT面对的只有一个临时表。SELECT会读取临时表并形成一个新的。<br />
如果是由GROUP BY提供的，SELECT可能会面临多个临时表，SELECT会依次每一个临时表，并且在操作某一个临时表时，SELECT只会读取指定字段下的第一个数据，因为按该数据分组，同一个表该字段数据都相同。SELECT会将从多个临时表中读取的数据合成为一列并且保存到一个全新的临时表中。</li>
</ol>
<h4 id="高级用法-concat"><a class="markdownIt-Anchor" href="#高级用法-concat"></a> 高级用法 CONCAT</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    customer_id,</span><br><span class="line">    first_name,</span><br><span class="line">    last_name,</span><br><span class="line">    CONCAT(first_name, <span class="string">&#x27; &#x27;</span>, last_name) full_name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    sales.customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    full_name;</span><br></pre></td></tr></table></figure>
<h3 id="where命令"><a class="markdownIt-Anchor" href="#where命令"></a> <strong>WHERE命令</strong></h3>
<ol>
<li>执行顺序：<code>FROM</code> --&gt; <code>WHERE</code> --&gt; <code>SELECT/聚合函数</code></li>
<li>书写顺序： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT 字段名，函数，子查询</span><br><span class="line">FROM   表文件</span><br><span class="line">WHERE  关系运算/逻辑运算列表</span><br></pre></td></tr></table></figure>
</li>
<li>作用：循环遍历所有的数据行，每次得到一个数据行，判断是否需要被<strong>定位</strong>。循环结束后，WHERE命令会生成一个所有定位数据行的临时表。</li>
<li>运算符：<br />
a. <strong>关系运算</strong>：<br />
<code>=</code>：如果指定的字符中空格，直接单/双引号引起来即可: <code>'likes me'</code> ，如果字符内部有单引号，则使用 <code>&quot;Johnson's mother&quot;</code>, <code>'Johnson''s mother'</code>, <code>'Johnson\'s mother'</code> ，用来表示 <code>Johnson's mother</code> 。<br />
<code>!= </code>或 <code>&lt;&gt;</code><br />
<code>&gt;</code><br />
<code>&lt;</code><br />
<code>&gt;=</code><br />
<code>&lt;=</code><br />
b. <strong>逻辑运行</strong>：<br />
<code>and</code> 或 <code>&amp;&amp;</code><br />
<code>or</code> 或 <code>||</code><br />
<code>between ... and ...</code>：闭集合<br />
<code>in(选项1，选项2，选项3)</code><br />
<code>not in(选项1，选项2，选项3)</code><br />
c. <strong>特殊运算符</strong>：null值表示一个不确定的值，而非空含义。<br />
所以null值不可以参加运算，即”=null“不成立。<br />
<code>is null</code><br />
<code>is not null</code><br />
d. <strong>like / not like 命令：模糊查询</strong><br />
<code>%</code> 是一个通配符，表示一个长度任意的字符串；<br />
<code>_</code> 也是一个通配符，表示一个任意的字符<br />
1. 前置条件模糊查询：以s开头 <code>like 's%'</code>：   <code>select ename from emp where ename like 's%'</code><br />
2. 后置条件模糊查询：以s结尾 <code>like '%s'</code><br />
3. 包含s：<code>like &quot;%s%&quot;</code><br />
4. 第二个字母是S：<code>like '_S%'</code></li>
</ol>
<h4 id="聚合函数"><a class="markdownIt-Anchor" href="#聚合函数"></a> <strong>聚合函数</strong></h4>
<p>将一列数据看作是一个整体，进行纵向计算。<br />
语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 聚合函数([DISTINCT] 字段名) from 表名;</span><br></pre></td></tr></table></figure>
<p>所有的聚合函数是不计算 null 值的，但是如果该特征里面全都是 Null，那么聚合函数返回值也是 Null 。</p>
<ol>
<li><code>max(字段)</code><br />
<code>select max(sal) from emp where deptno=20</code></li>
<li><code>min(字段)</code></li>
<li><code>sum(字段)</code></li>
<li><code>avg(字段)</code></li>
<li><code>count(字段)</code> 不为null的个数</li>
<li><code>count(*) / count(1)</code> 统计数据行的个数，包含null</li>
</ol>
<p>三者区别和速度请参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/89299468">执行count(1)、count(*) 与 count(列名) 到底有什么区别？</a></p>
<p>如果在 select 中选择返回了聚合函数，那么其他返回的特征必须：</p>
<ol>
<li>也是聚合函数的结果</li>
<li>是 <code>group by</code> 的键</li>
</ol>
<h3 id="group-by命令"><a class="markdownIt-Anchor" href="#group-by命令"></a> <strong>GROUP BY命令</strong></h3>
<ol>
<li>分组：先根据分组字段数据种类，将临时表进行分类。然后将具有相同特征的数据行读取出来保存到一个全新的临时表中。</li>
<li>举例：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT JOB, COUNT(*)</span><br><span class="line">FROM EMP</span><br><span class="line">WHERE DEPTNO=30</span><br><span class="line">GROUP BY JOB</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>执行顺序为：<br />
<code>FROM</code>--&gt;<code>WHERE</code>--&gt;<strong><code>GROUP BY</code></strong>--&gt;<code>SELECT</code><br />
选择表--&gt;定位数据行--&gt;根据属性分组--&gt;按要求输出</li>
<li>只有<code>group by</code>命令有机会在执行完毕后，依次生成多个临时表</li>
</ol>
<h3 id="having命令"><a class="markdownIt-Anchor" href="#having命令"></a> <strong>HAVING命令</strong></h3>
<ol>
<li>执行顺序：<code>FROM</code>--&gt;<code>WHERE</code>--&gt;<code>GROUP BY</code>--&gt;<strong><code>HAVING</code></strong>--&gt;<code>SELECT</code></li>
<li>只能出现在<code>GROUP BY</code>命令后</li>
<li>通过统计临时表中的信息决定是否删除<strong>整个临时表</strong></li>
<li>只有<code>HAVING</code>命令有可能删除临时表。</li>
<li><code>WHERE</code> 不能对聚合函数进行判断，而<code>HAVING</code>可以。</li>
<li><code>HAVING</code> 处理的对象只能是 1. A grouping attribute or 2. Aggregated function .</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Courses 表只有 class, student 两个字段</span><br><span class="line"># 查询 人数大于 5 的 class</span><br><span class="line">SELECT class</span><br><span class="line">FROM Courses</span><br><span class="line">GROUP BY class</span><br><span class="line">HAVING count(DISTINCT *)&gt;=5;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">FROM Courses</span><br><span class="line">GROUP BY class;</span><br><span class="line">命令得到的是多个临时表，每个临时表中的 `class` 字段都相同</span><br><span class="line">所以这里的 HAVING 可以有多种方法：</span><br><span class="line">1. HAVING(DISTINCT student) -- 如果 stu 字段为 Null，则不会被计算</span><br><span class="line">2. HAVINF(DISTINCT *)</span><br><span class="line">3. HAVING(DISTINCT class)</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h3 id="order-by命令"><a class="markdownIt-Anchor" href="#order-by命令"></a> <strong>ORDER BY命令</strong></h3>
<p>语法：<code>SELECT 字段列表 FROM 表名 ORDER BY 字段1 排序方式1, 字段2 排序方式2</code></p>
<p>按照字段1进行排序，如果相同则按照字段2排序。</p>
<p>排序方式为：</p>
<ul>
<li><code>asc</code>：生序，默认</li>
<li><code>desc</code>：降序</li>
</ul>
<h3 id="limit命令"><a class="markdownIt-Anchor" href="#limit命令"></a> <strong>LIMIT命令</strong></h3>
<p>可以看成是截断</p>
<p>从指定位置的数据行开始，向下截取指定数量的数据行。将截取出来的数据保存到一个全新的临时表中。用于分页展示数据（第一页，第二页 …）。</p>
<p>语法：<code>SELECT 字段列表 FROM 表名 LIMIT 起始索引, 查询记录数量;</code></p>
<p>从第【起始索引】行开始，截取【查询记录数量的】行数。<br />
【起始索引】= （【查询页码】-1 ）*【查询记录数量】<br />
<strong>注意：数据行位置默认从0开始计算，可以省略。</strong></p>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结：</h3>
<ul>
<li>执行顺序：<br />
<code>FROM</code>--&gt;<code>WHERE</code>--&gt;<code>GROUP BY</code>--&gt;<code>HAVING</code>--&gt;<code>SELECT</code>--&gt;<code>ORDER BY</code>--&gt;<code>LIMIT</code></li>
<li>书写顺序：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT  字段，函数，子查询</span><br><span class="line">FROM    表</span><br><span class="line">WHERE   定位数据行条件</span><br><span class="line">GROUP BY  分组字段</span><br><span class="line">HAVING  删除的判断条件</span><br><span class="line">ORDER BY  排序字段</span><br><span class="line">LIMIT   起始行位置，从改行开始向下截取行数</span><br></pre></td></tr></table></figure>
<h3 id="常用查询操作"><a class="markdownIt-Anchor" href="#常用查询操作"></a> 常用查询操作</h3>
<h5 id="多字段分组查询"><a class="markdownIt-Anchor" href="#多字段分组查询"></a> 多字段分组查询</h5>
<p>需求：查询各个部门下各个职位的人数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select DEPTNO, JOB, count(*)</span><br><span class="line">from emp</span><br><span class="line">GROUP BY DEPTNO,JOB  #多字段分组</span><br></pre></td></tr></table></figure>
<ol>
<li>多字段分组时，分组顺序对于最终查询的结果没有任何影响。</li>
<li>多字段分组时，GROUP BY一次只能根据一个分组字段进行分组。<code>GROUP BY DEPTNO,JOB</code>时，需要执行两次。</li>
<li>从第二个分组字段开始，操作上一个分组字段生成的临时表。对于<code>GROUP BY DEPTNO,JOB</code>，当执行<code>GROUP BY JOB</code>时，在<code>GROUP BY DEPTNO</code>生成的临时表上进行操作。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/MySQL%20info/mysql%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/MySQL%20info/mysql%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">mysql数据服务器介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 23:29:24" itemprop="dateCreated datePublished" datetime="2021-03-04T23:29:24-08:00">2021-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>357</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="服务器介绍"><a class="markdownIt-Anchor" href="#服务器介绍"></a> 服务器介绍</h3>
<ol>
<li>服务器是一种软件，不是硬件。</li>
<li>不同服务器负责调用不同的文件类型。</li>
</ol>
<h3 id="表文件数据库和数据库服务器"><a class="markdownIt-Anchor" href="#表文件数据库和数据库服务器"></a> 表文件，数据库和数据库服务器</h3>
<ul>
<li>
<p>表文件</p>
<ul>
<li>简介：
<ol>
<li>以&quot;.frm&quot;结尾的一种文件</li>
<li>存在于服务端计算机硬盘上</li>
<li>以数据形式进行数据存储的文件</li>
</ol>
</li>
<li>结构：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">            student.frm</span><br><span class="line">标题行  sid  sname  sex   age   home</span><br><span class="line">数据行  10   lyl    man   20   jiangsu</span><br><span class="line">       20   lz    woman  10   jiangsu</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>数据库：存放表文件的文件夹</p>
</li>
<li>
<p>数据库服务器：</p>
<ol>
<li>一种专门对表文件进行调用和管理的软件</li>
<li>用户通过数据库服务器对数据库进行操作</li>
</ol>
</li>
</ul>
<h3 id="sql命令"><a class="markdownIt-Anchor" href="#sql命令"></a> SQL命令</h3>
<ul>
<li>全称：Structured Query Language 结构化查询编程语言</li>
<li>作用：用户通过SQL命令向数据库服务器发送请求，用于对表文件进行调用管理</li>
<li>特点：包含主谓宾</li>
</ul>
<h3 id="数据库服务器分类"><a class="markdownIt-Anchor" href="#数据库服务器分类"></a> 数据库服务器分类</h3>
<ol>
<li>关系型数据库服务器<br />
a. 管理的表文件有隶属关系，可以完整地描述一段数据<br />
b. 在查询时，所涉及的数据比较多，因此查询的速度有所下降<br />
c. 分类：甲骨文公司的Oracle和Mysql，微软公司的SqlServer</li>
<li>非关系型数据库服务器<br />
a. 表文件都是独立的，无法描述一段完整的数据<br />
b. 查询的大数据比较少，查询速度快</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/MySQL%20info/mysql%20DCL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/MySQL%20info/mysql%20DCL/" class="post-title-link" itemprop="url">mysql DCL Data Control Language</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 22:44:21" itemprop="dateCreated datePublished" datetime="2021-03-04T22:44:21-08:00">2021-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>59</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>DCL：Data Control Language 数据库控制语言，用来管理<strong>数据库用户</strong>，控制<strong>数据库的访问权限</strong>。</p>
<h2 id="管理用户"><a class="markdownIt-Anchor" href="#管理用户"></a> 管理用户</h2>
<ol>
<li>查询用户，直接查询 user 表</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use mysql</span><br><span class="line">select * from user;</span><br></pre></td></tr></table></figure>
<p>…</p>
<p>不看了，详见黑马程序员 。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/%E5%A4%9A%E6%A8%A1%E6%80%81/detection-rcnn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/%E5%A4%9A%E6%A8%A1%E6%80%81/detection-rcnn/" class="post-title-link" itemprop="url">detection-rcnn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 22:44:21" itemprop="dateCreated datePublished" datetime="2021-03-04T22:44:21-08:00">2021-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MultiModal/" itemprop="url" rel="index"><span itemprop="name">MultiModal</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>45</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI5MzUyMjcxNA==&amp;mid=2247501349&amp;idx=1&amp;sn=d412f585e8597897bac7aa1a6e2fb249&amp;chksm=ec725a50db05d3464113fb6ef1291632c019055789a052e594afc66723add0b16692cca998fa&amp;token=107209320&amp;lang=zh_CN#rd">Faster R-CNN 之数据处理</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI5MzUyMjcxNA==&amp;mid=2247501325&amp;idx=1&amp;sn=6480884d9952baa7f43fc0724882aed1&amp;chksm=ec725a78db05d36e1af470a54b433f7c5a173ed7f6e5cead897eb6183331038bb94d128b3208&amp;token=107209320&amp;lang=zh_CN#rd">二阶段目标检测介绍 – 二阶段目标检测算法（RCNN 家族）</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI5MzUyMjcxNA==&amp;mid=2247501191&amp;idx=1&amp;sn=0c701117c7fb78de8b4fcd2aacc25475&amp;chksm=ec7259f2db05d0e4a59bdcb95d88777780aa8848ff462451a81606971a3af1bb028de483241b&amp;token=107209320&amp;lang=zh_CN#rd">Faster RCNN 中核心 RPN 原理解析</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43702653/article/details/123973629">https://blog.csdn.net/weixin_43702653/article/details/123973629</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/%E5%A4%9A%E6%A8%A1%E6%80%81/multi-moddal%20backbones/Multi-Modal-backbone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/%E5%A4%9A%E6%A8%A1%E6%80%81/multi-moddal%20backbones/Multi-Modal-backbone/" class="post-title-link" itemprop="url">Multi-Modal-backbone</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 22:44:21" itemprop="dateCreated datePublished" datetime="2021-03-04T22:44:21-08:00">2021-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MultiModal/" itemprop="url" rel="index"><span itemprop="name">MultiModal</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>42 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/625926419">多模态大模型超详细解读 (目录)</a></p>
<p><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1728963852075046389&amp;wfr=spider&amp;for=pc">五花八门的多模态模型如何选择？profile-avatar</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/622220960">[论文概览] | 多模态大模型进展概览</a></p>
<p>目录：<br />
- <a href="#click_me_jump1">Clip - ICML 2021</a><br />
- <a href="#click_me_jump2">ViLT - ICML 2021</a><br />
- <a href="#click_me_jump3">ALBEF - NeurIPS 2021</a><br />
- <a href="#click_me_jump4">Flamingo - CVPR 2022</a><br />
- <a href="#click_me_jump5">METER - CVPR 2022</a><br />
- <a href="#click_me_jump6">CoCa - 2022</a><br />
-</p>
<p><span id="click_me_jump1"></span></p>
<h1 id="clip"><a class="markdownIt-Anchor" href="#clip"></a> Clip</h1>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/625165635">多模态超详细解读 (一)：CLIP：大规模语言-图像对比预训练实现不俗 Zero-Shot 性能</a></p>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2103.00020.pdf">OpenAI : Learning Transferable Visual Models From Natural Language Supervision (ICML 2021)</a><br />
<a target="_blank" rel="noopener" href="https://github.com/OpenAI/CLIP">https://github.com/OpenAI/CLIP</a></p>
<p>动机：GPT3 的出现，让 zero-shot nlp tasks 成为可能，但是CV 中大家还在使用高质量，密集标注数据集 (如 ImageNet-1K) 进行预训练， zero-shot 效果差。所以这里提出使用自然语言来监督，进行图像表征学习的工作。</p>
<p>互联网上存在大量公开可用的无标注文本数据集，作者创建了一个包含4亿对 (图像，文本) 的新图像分类数据集，并通过对比语言-图像预训练的方式训练了 CLIP 模型。</p>
<h2 id="webimagetext-wit-数据集"><a class="markdownIt-Anchor" href="#webimagetext-wit-数据集"></a> WebImageText (WIT) 数据集</h2>
<p>包含4亿对 (图像，文本) 对，这些数据来自互联网上各种公开可用的资源。<br />
而且这个数据清理得非常好，质量是非常高的，这也可能是 CLIP 这么强大的主要原因之一。<br />
结果数据集的总字数与用于训练 GPT-2 的 WebText 数据集相似，因此作者将此数据集称为 WebImageText (WIT)。</p>
<h2 id="预训练方法"><a class="markdownIt-Anchor" href="#预训练方法"></a> 预训练方法</h2>
<p><strong>探索</strong></p>
<p>一开始的方法是联合训练了一个处理图像的 CNN 和一个处理文本的 Transformer 模型，来预测图像的 caption  ，但是效果不好，表现为 Scalability 很差，即效率（涨点速度）低。</p>
<p>原因：试图去预测每幅图片对应的文字的确切单词是什么，这个任务比较难。</p>
<p>可以仅预测整个文本与哪个图像配对，而不是该文本的确切单词，即对比学习，发现效果很好。</p>
<p><strong>预训练对比学习</strong></p>
<p>一个 size-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> batch 的 (图片，文本描述) ，分别使用 Image Encoder 和 Text Encoder 得到表征：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mn>1</mn></msub><mo separator="true">,</mo><mtext> </mtext><msub><mi>I</mi><mn>2</mn></msub><mo separator="true">,</mo><mtext> </mtext><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mtext> </mtext><msub><mi>I</mi><mi>N</mi></msub><mspace linebreak="newline"></mspace><msub><mi>T</mi><mn>1</mn></msub><mo separator="true">,</mo><mtext> </mtext><msub><mi>T</mi><mn>2</mn></msub><mo separator="true">,</mo><mtext> </mtext><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mtext> </mtext><msub><mi>T</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">I_1,\ I_2,\ ...\ I_N \\
T_1,\ T_2,\ ...\ T_N
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace"> </span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace"> </span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>然后对角线为正样本对，其余为负样本对，进行 in-batch contrastive learning ：<br />
<img src="https://pic1.zhimg.com/80/v2-65e1dbb935aa7804189dc100783a4940_1440w.webp" alt="" /></p>
<p><img src="https://cdn.mathpix.com/snip/images/ewTuOEvhtKYZ2_i5jnV2wRJxnQLX0GIgUtI9XcidxNU.original.fullsize.png" alt="" /></p>
<p><strong>模型</strong><br />
Image Encoder: ResNet &gt; ViT<br />
Text Encoder: Transformer , 文本序列用 [SOS] 和 [EOS] 令牌括起来，[EOS] 处 Transformer 末层的输出被视为文本的特征 。</p>
<p>作者发现 CLIP 的性能</p>
<ul>
<li>对于文本编码器的容量不太敏感。</li>
<li>对于图像编码器 ResNet，同时缩放其深度，宽度，和输入分辨率的效果是最优的。</li>
</ul>
<p><strong>训练方式</strong><br />
从头训练: 不预先加载  Image Encoder &amp; Text Encoder 。<br />
使用线性投影: 权重为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub><mo separator="true">,</mo><mtext> </mtext><msub><mi>W</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">W_i,\ W_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ， 将每个编码器的表征映射到多模态的嵌入空间。<br />
<strong>数据增强: 只使用随机裁剪，温度系数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">τ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span> 的对数形式随整个模型一起训练。</strong></p>
<p><strong>Zero-Shot Transfer</strong><br />
使用 CLIP 的预训练好的 Image Encoder 和 Text Encoder 来做 Zero-Shot Transfer。</p>
<p>Image Encoder 是没有分类头 (最后的 Classifier) 的，也就是说它没法直接去做分类任务，所以说呢 CLIP 采用了下面的 Prompt Template 模式：</p>
<ul>
<li>待分类图像 🌄：喂入 CLIP 预训练好的 Image Encoder，得到特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi></mrow><annotation encoding="application/x-tex">I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span></li>
<li>候选分类文本标签 🏷️：把所有类别的词汇 “cat”, “dog” 等，做成一个 prompt：<strong>“A photo of a {object}”</strong> ，喂入 CLIP 预训练好的 Text Encoder，依次得到特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>T</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">T_1, T_2, ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span></span></li>
<li>点乘相似度 ，得到分数最高的一对，取其标签 。</li>
</ul>
<p>这里 Prompt 模版避免了 OOV， 同时设计重要：</p>
<ul>
<li>对于细粒度图像分类任务，比如 Oxford-IIIT Pets 数据集，prompt 就可以设置为：<strong>“A photo of a {label}, a type of pet.”</strong> 。比如 Food101 数据集，prompt 就可以设置为：<strong>“A photo of a {label}, a type of food.”</strong> 。<br />
比如 FGVC Aircraft 数据集，prompt 就可以设置为：&quot;<strong>A photo of a {label}, a type of aircraft.&quot;</strong> 。</li>
<li>对于 OCR 任务，加上一些文本或者数字的引号可以提升性能。</li>
<li>对于卫星图像分类数据集，prompt 就可以设置为：<strong>“a satellite photo of a {label}.”</strong> 。</li>
</ul>
<p>也可以选择不同 prompt 模版将结果进行 resemble 。</p>
<p><strong>Zero-Shot CLIP 与完全监督的基线 ResNet-50 相比</strong></p>
<ul>
<li>通用数据集效果很好</li>
<li>一些专业、复杂或抽象的任务上相当弱</li>
</ul>
<p><span id="click_me_jump2"></span></p>
<h1 id="vilt"><a class="markdownIt-Anchor" href="#vilt"></a> ViLT</h1>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/626163710">多模态超详细解读 (二)：ViLT：一种极简多模态学习框架 Baseline</a><br />
<a target="_blank" rel="noopener" href="https://github.com/NielsRogge/Transformers-Tutorials/blob/master/ViLT/Fine_tuning_ViLT_for_VQA.ipynb">Fine-tuning ViLT For visual question answering (VQA)</a></p>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2102.03334.pdf">ViLT: Vision-and-Language Transformer Without Convolution or Region Supervision (ICML 2021)</a><br />
<a target="_blank" rel="noopener" href="https://github.com/dandelin/vilt">https://github.com/dandelin/vilt</a></p>
<p>多模态融合经历两个部分 ：</p>
<ol>
<li>特征抽取：分别得到 image feature 和 text feature</li>
<li>特征融合：将  image feature 和 text feature 进行融合，得到融合特征。</li>
</ol>
<p><strong>多模态模型分类：</strong></p>
<p><img src="https://pic1.zhimg.com/80/v2-eda11a93af82d3d7a17df87631a77e84_720w.webp" alt="" /></p>
<p>VE: Visual Encoder<br />
TE: Text Encoder<br />
MI: Modality Interaction</p>
<p>(a) : VE 占大部分算力，MI 用简单的点积或浅注意层来表征两种模态中特征的相似性，i.e. VSE++ , SCAN</p>
<p>(b) : 视觉模型和文本模型都使用较大算力，用简单的点积或浅注意层来表征两种模态中特征的相似性，代表模型是 CLIP 。但是，这种方法对于视觉-语言下游任务性能很差，比如 CLIP 在 NLVR2 数据集上面性能较差，说明纵使单一模态的编码器很好，但是对其输出的简单融合可能也不足以学习复杂的视觉和语言任务，这可能就需要我们去研究更严格的跨模态交互方案了。</p>
<p>© : 视觉模型占大部分算力，使用 Transformer 对图像和文本特征的交互进行建模，代表模型是 FiLM 和 MoVie</p>
<p>(d) : 本文的 ViLT ，视觉模型和文本模型都极其简单（首个将VE设计的如TE一样轻量的方法），大部分计算力集中在模态的交互上面，使用 Transformer 对图像和文本特征的交互进行建模 。</p>
<p><strong>模态交互方式分类：</strong></p>
<ol>
<li>单塔交换：拼接在一起，给到 transformer，e.g. ViLT &amp; VisualBERT &amp; UNITER</li>
<li>双塔交互：e.g. CLIP &amp; ViLBERT &amp; LXMERT</li>
</ol>
<br>
<p><strong>动机：</strong><br />
当前常用的多模态融合模型一般需要使用一个 big image encoder 来处理图片，比如预先进行目标检测任务提取 image region feature ，相比之下  text encoder 的计算量就比较小了。</p>
<p>平常做实验的时候，视觉 Encoder 提取到的 region feature 可以提前缓存，以减小训练时的负担。但是在实际应用的时候，在面对新数据集的时候，还是必须 <strong>经历一个缓慢的提取 region feature 的过程</strong> 。</p>
<p>visual embedding的方法总共有三大类：</p>
<ul>
<li>region feature方法通常采用Faster R-CNN二阶段检测器提取region的特征</li>
<li>grid feature方法直接使用CNN提取grid的特征</li>
<li>patch projection方法将输入图片切片投影提取特征。ViLT是首个使用patch projection来做visual embedding的方法。</li>
</ul>
<p><img src="https://pic2.zhimg.com/80/v2-c94fc0e580ad16d68bceb535634d93a5_1440w.webp" alt="" /></p>
<ol>
<li>Convolution-Free Feature Extraction: 直接使用 Patch Embedding 编码图像，无需目标检测；同时直接 Token Embedding 编码文本，将每个模态的特征抽取部分最小化 ；</li>
<li>ViT based Feature Interaction ：把主要的计算量都放在了特征融合部分 。</li>
</ol>
<h2 id="模型"><a class="markdownIt-Anchor" href="#模型"></a> 模型</h2>
<p>对于权重以 ViT-B/32 的预训练权重做初始化模型 ViLT-B/32, 隐维度大小 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> 为 768 , 深度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 为 12, Patch 大小 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> 为 32 , MLP 中间尺寸大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>768</mn><mo>=</mo><mn>3072</mn></mrow><annotation encoding="application/x-tex">4 \times 768=3072</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">7</span><span class="mord">6</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">0</span><span class="mord">7</span><span class="mord">2</span></span></span></span>, 注意力 head 数为 12 。</p>
<p><img src="https://pic3.zhimg.com/v2-796f44eae0f53d548feb46c0787913da_b.jpg" alt="" /></p>
<p>公式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mover accent="true"><mi>t</mi><mo>ˉ</mo></mover></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><msub><mi>t</mi><mtext>class </mtext></msub><mo separator="true">;</mo><msub><mi>t</mi><mn>1</mn></msub><mi>T</mi><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msub><mi>t</mi><mi>L</mi></msub><mi>T</mi><mo fence="true">]</mo></mrow><mo>+</mo><msup><mi>T</mi><mtext>pos </mtext></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mover accent="true"><mi>v</mi><mo>ˉ</mo></mover></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><msub><mi>v</mi><mtext>class </mtext></msub><mo separator="true">;</mo><msub><mi>v</mi><mn>1</mn></msub><mi>V</mi><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msub><mi>v</mi><mi>N</mi></msub><mi>V</mi><mo fence="true">]</mo></mrow><mo>+</mo><msup><mi>V</mi><mtext>pos </mtext></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mi>z</mi><mn>0</mn></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mover accent="true"><mi>t</mi><mo>ˉ</mo></mover><mo>+</mo><msup><mi>t</mi><mtext>type </mtext></msup><mo separator="true">;</mo><mover accent="true"><mi>v</mi><mo>ˉ</mo></mover><mo>+</mo><msup><mi>v</mi><mtext>type </mtext></msup><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mover accent="true"><mi>z</mi><mo>^</mo></mover><mi>d</mi></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi mathvariant="normal">MSA</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi mathvariant="normal">LN</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msup><mi>z</mi><mrow><mi>d</mi><mo>−</mo><mn>1</mn></mrow></msup><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mo>+</mo><msup><mi>z</mi><mrow><mi>d</mi><mo>−</mo><mn>1</mn></mrow></msup><mo separator="true">,</mo><mtext> </mtext><mi>d</mi><mo>=</mo><mn>1...</mn><mi>D</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mi>z</mi><mi>d</mi></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi mathvariant="normal">MLP</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi mathvariant="normal">LN</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msup><mover accent="true"><mi>z</mi><mo>^</mo></mover><mi>d</mi></msup><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mo>+</mo><msup><mover accent="true"><mi>z</mi><mo>^</mo></mover><mi>d</mi></msup><mo separator="true">,</mo><mtext> </mtext><mi>d</mi><mo>=</mo><mn>1...</mn><mi>D</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>p</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>tanh</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msubsup><mi>z</mi><mn>0</mn><mi>D</mi></msubsup><msub><mi>W</mi><mtext>pool </mtext></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\bar{t} &amp; =\left[t_{\text {class }} ; t_1 T ; \cdots ; t_L T\right]+T^{\text {pos }} \\
\bar{v} &amp; =\left[v_{\text {class }} ; v_1 V ; \cdots ; v_N V\right]+V^{\text {pos }} \\
z^0 &amp; =\left[\bar{t}+t^{\text {type }} ; \bar{v}+v^{\text {type }}\right] \\
\hat{z}^d &amp; =\operatorname{MSA}\left(\operatorname{LN}\left(z^{d-1}\right)\right)+z^{d-1},\ d=1...D \\
z^d &amp; =\operatorname{MLP}\left(\operatorname{LN}\left(\hat{z}^d\right)\right)+\hat{z}^d,\ d=1...D  \\
p &amp; =\tanh \left(z_0^D W_{\text {pool }}\right)
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.193655em;vertical-align:-4.3468275em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.8468275em;"><span style="top:-7.0068275em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.75186em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-3.18408em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord">ˉ</span></span></span></span></span></span></span></span></span><span style="top:-5.506827499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.56778em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">ˉ</span></span></span></span></span></span></span></span></span><span style="top:-3.982719499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span><span style="top:-2.4236114999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.19444em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span><span style="top:-0.8645034999999992em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span><span style="top:0.6868274999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.3468275em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.8468275em;"><span style="top:-7.0068275em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">class </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose delimcenter" style="top:0em;">]</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714392em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pos </span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-5.506827499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">class </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose delimcenter" style="top:0em;">]</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714392em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pos </span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.982719499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.75186em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-3.18408em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">type </span></span></span></span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.56778em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">type </span></span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span><span style="top:-2.4236114999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mord mathrm">M</span><span class="mord mathrm">S</span><span class="mord mathrm">A</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mop"><span class="mord mathrm">L</span><span class="mord mathrm">N</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span><span style="top:-0.8645034999999992em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mord mathrm">M</span><span class="mord mathrm">L</span><span class="mord mathrm">P</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mop"><span class="mord mathrm">L</span><span class="mord mathrm">N</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.19444em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.19444em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span><span style="top:0.6868274999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop">tanh</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pool </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.3468275em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>
<p>Text Encoder :  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>t</mi><mo>ˉ</mo></mover><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mo stretchy="false">(</mo><mi>L</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>H</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\bar{t} \in \mathbb R ^ {(L+1) \times H}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.79096em;vertical-align:-0.0391em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.75186em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span><span style="top:-3.18408em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">L</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>bert-base-uncased tokenizer</li>
<li>Word Embedding</li>
<li>add Text cls token :  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{class}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，方便和下游任务对接。</li>
<li>add Text Positional Embedding <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>T</mi><mtext>pos </mtext></msup></mrow><annotation encoding="application/x-tex">T^{\text {pos }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pos </span></span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
</li>
<li>
<p>Visual Encoder : <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>v</mi><mo>ˉ</mo></mover><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mo stretchy="false">(</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>H</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\bar{v} \in \mathbb R ^ {(N+1)\times H}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.60688em;vertical-align:-0.0391em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.56778em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>Linear Projection Patch Embedding : flatten to 1-d patch vector <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mo stretchy="false">(</mo><msup><mi>P</mi><mn>2</mn></msup><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N \times (P^2 C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span> , then linear projection <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mo stretchy="false">(</mo><msup><mi>P</mi><mn>2</mn></msup><mi>C</mi><mo stretchy="false">)</mo><mo>→</mo><mi>N</mi><mo>×</mo><mi>H</mi></mrow><annotation encoding="application/x-tex">N \times (P^2 C)\rightarrow N \times H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> ，这里需要让最终的维度和 text embedding 维度对齐。</li>
<li>add Visual cls token :  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">v_{class}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>add Visual Positional Embedding $V^{\text {pos }} $</li>
</ul>
</li>
<li>
<p>Transformer-based Modality Interaction Encoder : ViT-B/32 权重初始化 w/o Patch Projection初始化（实验发现 bert 初始化效果不好）</p>
<ul>
<li>add type embedding : 区分特征类型，即表示模态的变量</li>
<li>concatenate for transformer input  : <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>z</mi><mn>0</mn></msup></mrow><annotation encoding="application/x-tex">z^0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></li>
<li>TRM : 一共 D 层；遵循 bert 结构，每层 MSA + MLP 。</li>
<li>output : 输出的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>z</mi><mn>0</mn><mi>D</mi></msubsup></mrow><annotation encoding="application/x-tex">z_0^D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0894389999999998em;vertical-align:-0.24810799999999997em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4518920000000004em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24810799999999997em;"><span></span></span></span></span></span></span></span></span></span> 通过一个一个线性变换 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>p</mi><mi>o</mi><mi>o</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{pool}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>tanh</mtext></mrow><annotation encoding="application/x-tex">\text{tanh}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">tanh</span></span></span></span></span> 函数得到输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> 。</li>
</ul>
</li>
</ul>
<h2 id="预训练目标"><a class="markdownIt-Anchor" href="#预训练目标"></a> 预训练目标</h2>
<ol>
<li>
<p>Image Text Matching (ITM)：<br />
随机以 0.5 的概率将文本对应的图片 <strong>替换成不同的图片</strong> ，然后对文本标志位对应输出使用一个线性的 ITM head 将输出 <strong>Text cls token</strong> 映射成一个二值 logits，用来判断图像文本是否匹配。</p>
</li>
<li>
<p>word patch alignment (WPA) ：计算 textual subset 和 visual subset 的对齐分数<br />
通过 最优运输理论 optimal transport 来计算文本特征和图像特征的相似度，把这里的这些文本输出，和图像的输出当做一个概率分布，然后计算一下两个分布之间的距离，因为输入是一个文本图像对，那么按道理来说应该是匹配的，所以作者也希望 word patch alignment这里的距离，越小越好。</p>
</li>
<li>
<p>Whole Word Masking - Masked Language Modeling (MLM)：和 BERT 一样，随机以 0.15 的概率 mask 掉tokens 。</p>
</li>
</ol>
<p>Trick：</p>
<ul>
<li>Text：whole word masking<br />
其实图像这里作者也尝试了重建 loss，效果一般。</li>
<li>Image：数据增强，rand-augment w/o color inversion &amp; cutout ，保证了图像和文本还能尽可能的匹配在一起，不会有太大的出入。</li>
</ul>
<blockquote>
<p>在之前的那些多模态的方法里，尤其是图2 c里画的那些借鉴于目标检测的多模态学习，它了是没法使用数据增强的，因为他们在训练的时候了，都是提前把特征抽出来，存在本地硬盘里，原图长什么样，特征就是什么样，如果你需要把原图做数据增强，那你的特征就得重新抽取，这会变得很麻烦而且很贵，所以没人这么做过，这也就意味着所有之前的工作，哪怕到2021年的工作，都没有用数据增强，这是不是听起来就很不合理，明明你知道数据增强很有用，那你不用。</p>
</blockquote>
<h2 id="实验-微调"><a class="markdownIt-Anchor" href="#实验-微调"></a> 实验 &amp; 微调</h2>
<p>预训练数据集合：Microsoft COCO (MSCOCO), Visual Genome (VG), SBU Captions (SBU) , Google Conceptual Captions (GCC) 。这4个数据集合起来一般叫做 4 Million 的设置，因为它们的图片数加起来差不多是 4 Million。</p>
<p>微调数据集合</p>
<ul>
<li>分类任务：
<ul>
<li>
<p>Visual Question Answering (VQA) 任务借助 VQAv2 数据集来评估。VQA 任务要求给定图像对和自然语言问题，寻求答案。带注释的答案最初是自由形式的自然语言，但常见的做法是将任务转换为具有 3,129 个答案的分类任务。</p>
</li>
<li>
<p>Natural Language for Visual Reasoning (NLVR) 任务借助 NLVR2 数据集来评估。NLVR 任务是给定两个图像的三元组和自然语言的问题，做二元分类的任务。由于与预训练设置不同有两个输入图像，因此下游任务存在多种策略。在 ViLT 中，输出是两个图片，一个问题，那么分成 (问题，图片1) 和 (问题，图片2)，并把它们分别喂给 ViLT 模型，得到的两个 Pooled Representation，也就是 p 拼接起来，最后输出分类结果。</p>
</li>
</ul>
</li>
<li>检索任务: MSCOCO 和 Flickr30K</li>
</ul>
<p><span id="click_me_jump3"></span></p>
<h1 id="albef"><a class="markdownIt-Anchor" href="#albef"></a> ALBEF</h1>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2107.07651.pdf">Align before Fuse: Vision and Language Representation Learning with Momentum Distillation (NeurIPS 2021)</a><br />
<a target="_blank" rel="noopener" href="https://github.com/salesforce/ALBEF/">https://github.com/salesforce/ALBEF/</a></p>
<p>大部分 <strong>视觉-语言预训练 (Vision-and-Language Pre-training, VLP)</strong> 的问题 ：</p>
<ol>
<li>使用一个多模态的 Transformer 编码器融合图像 token 与文本 token 的信息融合，但是因为 Image Feature 和 Text Feature 在输入给 Transformer 时是 <strong>没对齐的</strong> ，即嵌入特征各自在各自的空间中吗，导致这个多模态 Transformer 无法准确地学习到图文的关联关系。</li>
<li>目标检测器计算代价较高且延时较大-&gt; ViLT</li>
<li>预训练所使用的图像文本数据集是从网络上收集的，内容上比较嘈杂。现有的预训练目标，例如 MLM 可能会过拟合噪声文本，降低模型的泛化能力。</li>
</ol>
<p>基于此：</p>
<ol>
<li>先用对比学习损失  image-text contrastive loss，对齐 Image Feature 和 Text Feature ，然后再放入 Transformer 中融合。</li>
<li>Visual Encoder 和  Text Encoder 均不使用目标检测器。</li>
<li>训练过程中使用基于 <strong>动量蒸馏 (MoD)</strong> 的方法使模型能够利用更大的带噪声数据集。<br />
原理：在训练期间，作者维持一个动量模型，其参数就是之前模型参数的移动平均。然后使用这个动量模型生成伪目标作为额外的监督。即让「滑动平均的 model」去预测，梯度返回给最新的模型。<br />
作用：当数据中有噪声导致监督信号不合理时，动量模型就可以给出额外的监督信号，改善模型的预训练。作者表明 MoD 不仅适用于预训练数据集有噪声的情况， <strong>还适用于预训练数据集很干净的情况。</strong></li>
</ol>
<h2 id="模型-2"><a class="markdownIt-Anchor" href="#模型-2"></a> 模型</h2>
<p>如下图1所示是 ALBEF 的模型架构，包含：</p>
<ul>
<li>一个图像编码器：图像编码器是12层 ViT-B/16, 权重初始化来自于在 ImageNet-1K 上面预训练的 DeiT 模型，把输入图片编码成 Image token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">{</mo><msub><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">v</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">v</mi><mi>N</mi></msub><mo fence="true">}</mo></mrow><annotation encoding="application/x-tex">\left\{\boldsymbol{v}_{\mathrm{cls}}, \boldsymbol{v}_1, \ldots, \boldsymbol{v}_N\right\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">}</span></span></span></span></span> 。</li>
<li>一个文本编码器：Bert-base 的前 6 层，把输入文本编码成 Text token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">{</mo><msub><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">w</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">w</mi><mi>N</mi></msub><mo fence="true">}</mo></mrow><annotation encoding="application/x-tex">\left\{\boldsymbol{w}_{\mathrm{cls}}, \boldsymbol{w}_1, \ldots, \boldsymbol{w}_N\right\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">}</span></span></span></span></span> 。<br />
<strong>视觉编码器的体量大于文本, 经验发现这样做效果好。</strong></li>
<li>一个多模态编码器：是 BERT 的后6层做多模态编码。</li>
</ul>
<p>这里的 ckpt 倒是和 ViLT 不一样了，我觉得也更符合直觉，图像用 vit，文本用 bert；而不是只使用 ViT 。</p>
<p><img src="https://pic1.zhimg.com/80/v2-52f2d5cfd5bf5c93bf0fc382daeb12b4_720w.webp" alt="" /></p>
<h2 id="预训练目标-2"><a class="markdownIt-Anchor" href="#预训练目标-2"></a> 预训练目标</h2>
<p>用于图文融合之前对齐的损失函数 Image-Text Contrastive Learning (ITC)<br />
多模态预训练标配的完形填空目标函数 masked language modeling (MLM)<br />
用于多模态预训练的图文匹配损失函数 image-text matching (ITM)</p>
<p><strong>Image-Text Contrastive Learning (ITC) on uni-modal encoders</strong></p>
<p>旨在 fuse multi-modal feature 前，对齐 text feature 和 image feature 。</p>
<p>应用于 <strong>单模态图像编码器和文本编码器</strong>，ITC任务是在多模态融合之前就需要预训练的，也就是说ITC只涉及图像、文本encoder，不涉及多模态编码器。</p>
<p>将两个 768d cls token 投影为 256d token，然后计算相似度：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo>=</mo><msub><mi>g</mi><mi>v</mi></msub><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msub><mi>g</mi><mi>w</mi></msub><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">s=g_v\left(\boldsymbol{v}_{\mathrm{cls}}\right)^{\top} g_w\left(\boldsymbol{w}_{\mathrm{cls}}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p>
<p>同时作者这里借鉴 MoCo，</p>
<ul>
<li>
<p>通过滑动平均维护两个独立的 momentum uni-modal encoder ： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">g&#x27;_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.998892em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">g&#x27;_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.998892em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 。</p>
</li>
<li>
<p>维护两个动量负样本队列（文本负样本队列」和「图片负样本队列」），容量为 M</p>
</li>
<li>
<p>使用 momentum uni-modal encoder 编码动量负样本队列中的每一个负样本： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">g_v^{\prime}\left(\boldsymbol{v}_{\mathrm{cls}}^{\prime}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035em;vertical-align:-0.2831079999999999em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4168920000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831079999999999em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">g_w^{\prime}\left(\boldsymbol{w}_{\mathrm{cls}}^{\prime}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035em;vertical-align:-0.2831079999999999em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4168920000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831079999999999em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></p>
</li>
<li>
<p>用当前的模型（非动量模型）编码当前的正样本： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>v</mi></msub><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">g_v\left(\boldsymbol{v}_{\mathrm{cls}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>w</mi></msub><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">g_w\left(\boldsymbol{w}_{\mathrm{cls}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></p>
</li>
<li>
<p>得到相似度：</p>
</li>
</ul>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>g</mi><mi>v</mi></msub><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow><mtext> and  </mtext><mi>s</mi><mo stretchy="false">(</mo><mi>T</mi><mo separator="true">,</mo><mi>I</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>g</mi><mi>w</mi></msub><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">s(I, T)=g_v\left(\boldsymbol{v}_{\mathrm{cls}}\right)^{\top} g_w^{\prime}\left(\boldsymbol{w}_{\mathrm{cls}}^{\prime}\right)\text { and }  \ s(T, I)=g_w\left(\boldsymbol{w}_{\mathrm{cls}}\right)^{\top} g_v^{\prime}\left(\boldsymbol{v}_{\mathrm{cls}}^{\prime}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord"> and </span></span><span class="mspace"> </span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p>
<ul>
<li>得到 softmax-normalized image-to-text and text-to-image similarity</li>
</ul>
<p class='katex-block katex-error' title='ParseError: KaTeX parse error: Undefined control sequence: \
 at position 163: …
\text { and } \̲
̲p_m^{\mathrm{t}…'>p_m^{\mathrm{i} 2 \mathrm{t}}(I)  =\frac{\exp \left(s\left(I, T_m\right) / \tau\right)}{\sum_{m=1}^M \exp \left(s\left(I, T_m\right) / \tau\right)}
\text { and } \
p_m^{\mathrm{t} 2 \mathrm{i}}(T)  =\frac{\exp \left(s\left(T, I_m\right) / \tau\right)}{\sum_{m=1}^M \exp \left(s\left(T, I_m\right) / \tau\right)}
</p>
<ul>
<li>计算 Loss：</li>
</ul>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>itc </mtext></msub><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msub><mi mathvariant="double-struck">E</mi><mrow><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mo>∼</mo><mi>D</mi></mrow></msub><mrow><mo fence="true">[</mo><mi mathvariant="normal">H</mi><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold-italic">y</mi><mrow><mi mathvariant="normal">i</mi><mn>2</mn><mi mathvariant="normal">t</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msup><mi mathvariant="bold-italic">p</mi><mrow><mi mathvariant="normal">i</mi><mn>2</mn><mi mathvariant="normal">t</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo>+</mo><mi mathvariant="normal">H</mi><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold-italic">y</mi><mrow><mi mathvariant="normal">t</mi><mn>2</mn><mi mathvariant="normal">i</mi></mrow></msup><mo stretchy="false">(</mo><mi>T</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msup><mi mathvariant="bold-italic">p</mi><mrow><mi mathvariant="normal">t</mi><mn>2</mn><mi mathvariant="normal">i</mi></mrow></msup><mo stretchy="false">(</mo><mi>T</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {itc }}=\frac{1}{2} \mathbb{E}_{(I, T) \sim D}\left[\mathrm{H}\left(\boldsymbol{y}^{\mathrm{i} 2 \mathrm{t}}(I), \boldsymbol{p}^{\mathrm{i} 2 \mathrm{t}}(I)\right)+\mathrm{H}\left(\boldsymbol{y}^{\mathrm{t} 2 \mathrm{i}}(T), \boldsymbol{p}^{\mathrm{t} 2 \mathrm{i}}(T)\right)\right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">itc </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">I</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mclose mtight">)</span><span class="mrel mtight">∼</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathrm">H</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">t</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">p</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">t</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathrm">H</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">t</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">i</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">p</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">t</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">i</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span></span></p>
<p>其实就是两个点：</p>
<ul>
<li>锚点正样本来源于当前 batch，并且使用当前的 encoder</li>
<li>负样本来源于缓存的序列，模型也是动量模型</li>
</ul>
<p><strong>Masked Language Modeling (MLM) on the multi-modal encoder</strong><br />
15% 的 mask ratio</p>
<p><strong>Image-Text Matching Loss (ITM) on the multi-modal encoder</strong><br />
预测一对图像和文本是正样本还是负样本。作者使用多模态编码器的输出嵌入 [CLS] token 作为图像-文本对的联合表示，并通过一个 FC 层和一个 Softmax 来预测二类概率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>p</mi><mrow><mi>i</mi><mi>t</mi><mi>m</mi></mrow></msup></mrow><annotation encoding="application/x-tex">p^{itm}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.019104em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>还使用了 ITC 中计算得到的相似度在同一个 batch 内为每一个正样本对挖掘两个难负样本对:</p>
<ul>
<li>
<p>对于一个 Batch 中每个图像，ALBEF 会采样最难的那个文本样本作为负样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>( hard N text, pos Image )</mtext></mrow><annotation encoding="application/x-tex">\text{( hard N  text, pos Image )}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">( hard N text, pos Image )</span></span></span></span></span></p>
</li>
<li>
<p>对于一个 Batch 中每个文本，ALBEF 会采样最难的那个图像样本作为负样 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>( pos text, hard N Image )</mtext></mrow><annotation encoding="application/x-tex">\text{( pos text, hard N Image )}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">( pos text, hard N Image )</span></span></span></span></span></p>
</li>
<li>
<p>然后和正样本一起构成图文匹配损失。</p>
</li>
</ul>
<h2 id="momentum-distillation"><a class="markdownIt-Anchor" href="#momentum-distillation"></a> Momentum Distillation</h2>
<p>从网络上收集的图像-文本对往往是弱相关的：文本可能包含与图像无关的词，或者图像可能包含文本中没有描述的实体，影响了 ITC 和 MLM 。为了从嘈杂的数据中学习，我们提出了动量蒸馏法，即使用动量模型为图像-文本对比学习和掩码语言建模生成伪目标。</p>
<p>同时：动量提炼可以被解释为，动量模型的预测为每个图像-文本对产生一系列新的视角。</p>
<p><img src="https://cdn.mathpix.com/snip/images/i73ByKIO7wuvrs5pcLaQnxTn1Nv8LNRkOyu_SMhDNhg.original.fullsize.png" alt="" /></p>
<p>作者提出 <strong>「learn from pseudo-targets generated by the momentum model」</strong>，让动量模型充当 teacher model，生成伪标签，作为 base model 的监督信号，具体地：</p>
<p><strong>对于 ITC</strong><br />
原本正样本是 current base encoder 编码，负样本是 momentum encoder 编码：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>g</mi><mi>v</mi></msub><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow><mtext> and  </mtext><mi>s</mi><mo stretchy="false">(</mo><mi>T</mi><mo separator="true">,</mo><mi>I</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>g</mi><mi>w</mi></msub><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">s(I, T)=g_v\left(\boldsymbol{v}_{\mathrm{cls}}\right)^{\top} g_w^{\prime}\left(\boldsymbol{w}_{\mathrm{cls}}^{\prime}\right)\text { and }  \ s(T, I)=g_w\left(\boldsymbol{w}_{\mathrm{cls}}\right)^{\top} g_v^{\prime}\left(\boldsymbol{v}_{\mathrm{cls}}^{\prime}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord"> and </span></span><span class="mspace"> </span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p>
<p>这里则全都交给 momentum encoder 进行编码，得到新的相似度：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow><mtext> and </mtext><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>T</mi><mo separator="true">,</mo><mi>I</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><msup><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold-italic">w</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">⊤</mi></msup><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold-italic">v</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">s^{\prime}(I, T)=g_v^{\prime}\left(\boldsymbol{v}_{\mathrm{cls}}\right)^{\top} g_w^{\prime}\left(\boldsymbol{w}_{\mathrm{cls}}^{\prime}\right) \text { and } s^{\prime}(T, I)=g_w^{\prime}\left(\boldsymbol{w}_{\mathrm{cls}}\right)^{\top} g_v^{\prime}\left(\boldsymbol{v}_{\mathrm{cls}}^{\prime}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.051892em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord"> and </span></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2390079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.02778em;">w</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9890079999999999em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">v</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8018919999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p>
<p>可以看到左边的编码器从原始的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>g</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">g_w, g_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 变成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>g</mi><mi>w</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msubsup><mi>g</mi><mi>v</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">g_w^{\prime}, g_v^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.998892em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 。</p>
<p>然后还是一样地得到 soft pseudo-targets softmax-normalized image-to-text and text-to-image similarity <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold-italic">q</mi><mrow><mi mathvariant="normal">i</mi><mn>2</mn><mi mathvariant="normal">t</mi></mrow></msup><mo separator="true">,</mo><mtext> </mtext><msup><mi mathvariant="bold-italic">q</mi><mrow><mi mathvariant="normal">t</mi><mn>2</mn><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">i</mi></mrow></mrow></msup></mrow><annotation encoding="application/x-tex">\boldsymbol{q}^{\mathrm{i} 2 \mathrm{t}},\ \boldsymbol{q}^{\mathrm{t} 2 \mathrm{ii}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.024942em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">q</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.830502em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">t</span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">q</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.830502em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">t</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">i</span></span></span></span></span></span></span></span></span></span></span></span></span> ，作为 teacher similarity，让 base model 的结果和这个 teacher similarity 差距变小，这里使用了 KL 散度。</p>
<p>最终和原始的 loss 加权在一起即可：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="script">L</mi><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">c</mi></mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></msubsup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><msub><mi mathvariant="script">L</mi><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">c</mi></mrow></msub><mo>+</mo><mfrac><mi>α</mi><mn>2</mn></mfrac><msub><mi mathvariant="double-struck">E</mi><mrow><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo><mo>∼</mo><mi>D</mi></mrow></msub><mrow><mo fence="true">[</mo><mrow><mi mathvariant="normal">K</mi><mi mathvariant="normal">L</mi></mrow><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold-italic">q</mi><mrow><mi mathvariant="normal">i</mi><mn>2</mn><mi mathvariant="normal">t</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∥</mi><msup><mi mathvariant="bold-italic">p</mi><mrow><mi mathvariant="normal">i</mi><mn>2</mn><mi mathvariant="normal">t</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo>+</mo><mrow><mi mathvariant="normal">K</mi><mi mathvariant="normal">L</mi></mrow><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold-italic">q</mi><mrow><mi mathvariant="normal">t</mi><mn>2</mn><mi mathvariant="normal">i</mi></mrow></msup><mo stretchy="false">(</mo><mi>T</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∥</mi><msup><mi mathvariant="bold-italic">p</mi><mrow><mi mathvariant="normal">t</mi><mn>2</mn><mi mathvariant="normal">i</mi></mrow></msup><mo stretchy="false">(</mo><mi>T</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\mathrm{itc}}^{\mathrm{mod}}=(1-\alpha) \mathcal{L}_{\mathrm{itc}}+\frac{\alpha}{2} \mathbb{E}_{(I, T) \sim D}\left[\mathrm{KL}\left(\boldsymbol{q}^{\mathrm{i} 2 \mathrm{t}}(I) \| \boldsymbol{p}^{\mathrm{i} 2 \mathrm{t}}(I)\right)+\mathrm{KL}\left(\boldsymbol{q}^{\mathrm{t} 2 \mathrm{i}}(T) \| \boldsymbol{p}^{\mathrm{t} 2 \mathrm{i}}(T)\right)\right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.146108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999998em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">t</span><span class="mord mathrm mtight">c</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">m</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">d</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">t</span><span class="mord mathrm mtight">c</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">I</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mclose mtight">)</span><span class="mrel mtight">∼</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathrm">K</span><span class="mord mathrm">L</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">q</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">t</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mord">∥</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">p</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">t</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathrm">K</span><span class="mord mathrm">L</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">q</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">t</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">i</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mord">∥</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">p</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8805019999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">t</span></span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathrm mtight">i</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span></span></p>
<p><strong>对于 MLM</strong><br />
也是一样的让动量模型预测一个 mask token 的概率分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold-italic">q</mi><mrow><mi>m</mi><mi>a</mi><mi>s</mi><mi>k</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mover accent="true"><mi>T</mi><mo>^</mo></mover><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\boldsymbol{q}^{mask}(I, \hat T)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.19677em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">q</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ，然后指导 base model，得到最终的加权 loss：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="script">L</mi><mtext>mlm </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow></msubsup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><msub><mi mathvariant="script">L</mi><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">m</mi></mrow></msub><mo>+</mo><mi>α</mi><msub><mi mathvariant="double-struck">E</mi><mrow><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mover accent="true"><mi>T</mi><mo>^</mo></mover><mo stretchy="false">)</mo><mo>∼</mo><mi>D</mi></mrow></msub><mrow><mi mathvariant="normal">K</mi><mi mathvariant="normal">L</mi></mrow><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold-italic">q</mi><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">k</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mover accent="true"><mi>T</mi><mo>^</mo></mover><mo stretchy="false">)</mo><mi mathvariant="normal">∥</mi><msup><mi mathvariant="bold-italic">p</mi><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">k</mi></mrow></msup><mo stretchy="false">(</mo><mi>I</mi><mo separator="true">,</mo><mover accent="true"><mi>T</mi><mo>^</mo></mover><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {mlm }}^{\mathrm{mod}}=(1-\alpha) \mathcal{L}_{\mathrm{mlm}}+\alpha \mathbb{E}_{(I, \hat{T}) \sim D} \mathrm{KL}\left(\boldsymbol{q}^{\mathrm{msk}}(I, \hat{T}) \| \boldsymbol{p}^{\mathrm{msk}}(I, \hat{T})\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.146108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999998em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">mlm </span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">m</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">d</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">m</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">m</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34479999999999994em;"><span style="top:-2.382061em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">I</span><span class="mpunct mtight">,</span><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span><span style="top:-2.9523300000000003em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord mtight">^</span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mrel mtight">∼</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49293899999999985em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathrm">K</span><span class="mord mathrm">L</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">q</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">m</span><span class="mord mathrm mtight">s</span><span class="mord mathrm mtight">k</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∥</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">p</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">m</span><span class="mord mathrm mtight">s</span><span class="mord mathrm mtight">k</span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><strong>Usage</strong><br />
also apply MoD to the downstream tasks ;<br />
set the weight <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.4</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">4</span></span></span></span> for all pre-training and downstream tasks .</p>
<h2 id="实验"><a class="markdownIt-Anchor" href="#实验"></a> 实验</h2>
<p>图文检索任务 (Image-Text Retrieval) 包括两个子任务：图像到文本检索 (TR) 和文本到图像检索 (IR)。作者在 Flickr30K 和 COCO 这两个数据集上做了验证。</p>
<p>视觉蕴含任务 (Visual Entailment, SNLI-VE) 是一个细粒度的视觉推理任务，用于预测图像和文本之间的关系是蕴涵、中性或矛盾的。将 VE 视为三分类问题，并在多模态编码器的 [CLS] token 的输出结果加上分类头得到每个类的概率。</p>
<p>视觉问答任务 (Visual Question Answering, VQA) 要求模型预测给定图像和问题的答案。与现有的将 VQA 制定为多答案分类问题的方法不同，ALBEF 将 VQA 视为答案生成问题。<br />
作者使用6层的 Transformer Decoder 来生成答案。</p>
<p>自然语言视觉推理任务 (Natural Language for Visual Reasoning, NLVR2) 要求模型预测文本是否描述了一对图像。作者扩展了多模态编码器，以实现对两幅图像的推理。</p>
<p><span id="click_me_jump5"></span></p>
<h1 id="meter"><a class="markdownIt-Anchor" href="#meter"></a> Meter</h1>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2111.02387">An Empirical Study of Training End-to-End Vision-and-Language Transformers</a></p>
<p><span id="click_me_jump6"></span></p>
<h1 id="coca"><a class="markdownIt-Anchor" href="#coca"></a> CoCa</h1>
<p>Paper: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2205.01917">CoCa: Contrastive Captioners are Image-Text Foundation Models</a><br />
Code: <a target="_blank" rel="noopener" href="https://github.com/lucidrains/CoCa-pytorch">https://github.com/lucidrains/CoCa-pytorch</a><br />
Blog: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/627702632">多模态超详细解读 (九)：CoCa：对比学习和生成式任务训练多模态大模型</a></p>
<p>Co: Contrastive Loss<br />
Ca: Captioning (Generative) Loss</p>
<p>常规CV 和 多模态任务上已经出现了一些模型：</p>
<ol>
<li>CV 的编码模型，分类损失为：</li>
</ol>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">s</mi></mrow></msub><mo>=</mo><mo>−</mo><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mi>log</mi><mo>⁡</mo><msub><mi>q</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\mathrm{Cls}}=-p(y) \log q_\theta(x)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">C</span><span class="mord mathrm mtight">l</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<ol start="2">
<li>
<p>通过对比损失预训练 Dual-Encoder 的视觉模型和语言模型：</p>
<ul>
<li>能将 image 和 text 潜入到相同的空间，拥有模态对齐的能力（ cross-modal alignment capabilities ），所以比较适合 zero-shot image classification 和 image-text retrieval 任务 。<br />
损失函数为：</li>
</ul>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>Con </mtext></msub><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy="false">(</mo><munder><munder><mrow><mo fence="true">(</mo><munderover><mo>∑</mo><mi>i</mi><mi>N</mi></munderover><mi>log</mi><mo>⁡</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msubsup><mi>x</mi><mi>i</mi><mi mathvariant="normal">⊤</mi></msubsup><msub><mi>y</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><mi>σ</mi><mo fence="true">)</mo></mrow></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msubsup><mi>x</mi><mi>i</mi><mi mathvariant="normal">⊤</mi></msubsup><msub><mi>y</mi><mi>j</mi></msub><mi mathvariant="normal">/</mi><mi>σ</mi><mo fence="true">)</mo></mrow></mrow></mfrac></mrow><mo stretchy="true">⏟</mo></munder><mtext>image-to-text </mtext></munder><mo>+</mo><munder><munder><mrow><munderover><mo>∑</mo><mi>i</mi><mi>N</mi></munderover><mi>log</mi><mo>⁡</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msubsup><mi>y</mi><mi>i</mi><mi mathvariant="normal">⊤</mi></msubsup><msub><mi>x</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><mi>σ</mi><mo fence="true">)</mo></mrow></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msubsup><mi>y</mi><mi>i</mi><mi mathvariant="normal">⊤</mi></msubsup><msub><mi>x</mi><mi>j</mi></msub><mi mathvariant="normal">/</mi><mi>σ</mi><mo fence="true">)</mo></mrow></mrow></mfrac><mo fence="true">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>text-to-image </mtext></munder></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {Con }}=-\frac{1}{N}(\underbrace{\left(\sum_i^N \log \frac{\exp \left(x_i^{\top} y_i / \sigma\right)}{\sum_{j=1}^N \exp \left(x_i^{\top} y_j / \sigma\right)}\right.}_{\text {image-to-text }}+\underbrace{\left.\sum_i^N \log \frac{\exp \left(y_i^{\top} x_i / \sigma\right)}{\sum_{j=1}^N \exp \left(y_i^{\top} x_j / \sigma\right)}\right)}_{\text {text-to-image }}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Con </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:4.586995em;vertical-align:-2.7586590000000006em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283359999999995em;"><span style="top:-1.2057849999999994em;"><span class="pstrut" style="height:3.828336em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">image-to-text </span></span></span></span></span><span style="top:-3.8283359999999993em;"><span class="pstrut" style="height:3.828336em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span class="svg-align" style="top:-1.873287em;"><span class="pstrut" style="height:3.828336em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3.828336em;"><span class="pstrut" style="height:3.828336em;"></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59001em;"><span style="top:-2.128769em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.830908em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.27686399999999994em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7400100000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3070490000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9550490000000003em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7586590000000006em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:4.586995em;vertical-align:-2.7586590000000006em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283359999999995em;"><span style="top:-1.2057849999999994em;"><span class="pstrut" style="height:3.828336em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">text-to-image </span></span></span></span></span><span style="top:-3.8283359999999993em;"><span class="pstrut" style="height:3.828336em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span class="svg-align" style="top:-1.873287em;"><span class="pstrut" style="height:3.828336em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3.828336em;"><span class="pstrut" style="height:3.828336em;"></span><span class="mord"><span class="minner"><span class="mopen nulldelimiter"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59001em;"><span style="top:-2.128769em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.830908em;"><span style="top:-2.4231360000000004em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.27686399999999994em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7400100000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⊤</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3070490000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9550490000000003em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7586590000000006em;"><span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>因为在训练中没有学习模态信息交互的模块（ due to missing joint components to learn fused image and text representations ），所以不适用于 joint vision-language understanding tasks，比如 VQA 。</li>
</ul>
</li>
<li>
<p>使用生成式预训练方法的 Encoder-Decoder Model ，在 Encoder 侧编码图像，在 Decoder 侧生成文字 ，这种任务让模型学会建模视觉语言的联合表征，从而适用于 multi-modal understanding tasks 。<br />
但是一些这样的方法又缺少了 text-only representations 和 image embeddings 的对齐任务。<br />
Image Encoder + AG Text Decoder ，损失为</p>
</li>
</ol>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>Cap </mtext></msub><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><mi>log</mi><mo>⁡</mo><msub><mi>P</mi><mi>θ</mi></msub><mrow><mo fence="true">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>y</mi><mrow><mo>&lt;</mo><mi>t</mi></mrow></msub><mo separator="true">,</mo><mi>x</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {Cap }}=-\sum_{t=1}^T \log P_\theta\left(y_t \mid y_{&lt;t}, x\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Cap </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0954490000000003em;vertical-align:-1.267113em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.882887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.267113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17737em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">x</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p>
<br>
<h2 id="model"><a class="markdownIt-Anchor" href="#model"></a> Model</h2>
<p>所以本文就是想提出一个模型，有三种能力，让模型：</p>
<ul>
<li>有很好的图像独立编码能力  -&gt; single-encoder</li>
<li>有两个模态独立编码的对齐能力 -&gt;  dual-encoder</li>
<li>有两个模态的理解交互能力  -&gt; encoder-decoder</li>
</ul>
<p><img src="https://cdn.mathpix.com/snip/images/gMaO2CfvyMoxtUFG4F3f39Pl3DPkrvpGAxbHAcNUm5M.original.fullsize.png" alt="" /></p>
<p>具体地，作者提出模型 CoCa ，结构为 encoder-decoder：</p>
<ul>
<li>a single Image Encoder</li>
<li>a two-part Text Decoder
<ul>
<li>a uni-modal decoder: <strong>Self attention</strong> to encode <strong>text-only representations</strong></li>
<li>a multi-modal decoder: <strong>Cross-Attend</strong> image encoder outputs to learn <strong>multi-modal image-text representations</strong></li>
</ul>
</li>
</ul>
<p><strong>a simple encoder-decoder approach that seamlessly combines the three training paradigms.</strong></p>
<h2 id="contrastive-captioners-pretraining"><a class="markdownIt-Anchor" href="#contrastive-captioners-pretraining"></a> Contrastive Captioners Pretraining</h2>
<p><img src="https://cdn.mathpix.com/snip/images/MHOge480Yy6fpCah4iKv-gL8hf6oF6PhIgokcfW-xbQ.original.fullsize.png" alt="Figure 2: Detailed illustration of CoCa architecture and training objectives." /></p>
<p>预训练目标为  contrastive loss 和 captioning (generative) loss ：</p>
<ul>
<li><strong>the contrastive objective</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>Con </mtext></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {Con }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Con </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> between outputs of the image encoder and uni-modal text decoder , 使得二者都具备独立提取图像特征和文本特征的能力，而且学习到的是偏全局的图文表征。<br />
第一个对比损失的表征来自于 Image encoder 和第一层  uni-modal Text decoder</li>
</ul>
<blockquote>
<p>The single-encoder cross- entropy classification objective can be interpreted as a special case of the generative approach applied on image annotation data, when the vocabulary is the set of all label names.</p>
</blockquote>
<ul>
<li><strong>the captioning objective</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>Cap </mtext></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {Cap }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Cap </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> at the output of the multi-modal decoder , 使得其具有联合提取图像文本联合表征的能力，而且学习到的是偏细粒度的图文表征。<br />
第二个自回归损失来自于 Image encoder 和第二层 multi-modal AG Text decoder</li>
</ul>
<p>总损失为：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>CoCa </mtext></msub><mo>=</mo><msub><mi>λ</mi><mtext>Con </mtext></msub><mo>⋅</mo><msub><mi mathvariant="script">L</mi><mtext>Con </mtext></msub><mo>+</mo><msub><mi>λ</mi><mtext>Cap </mtext></msub><mo>⋅</mo><msub><mi mathvariant="script">L</mi><mtext>Cap </mtext></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text {CoCa }}=\lambda_{\text {Con }} \cdot \mathcal{L}_{\text {Con }}+\lambda_{\text {Cap }} \cdot \mathcal{L}_{\text {Cap }}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">CoCa </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Con </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Con </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Cap </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Cap </span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>效率：</strong><br />
ALBEF 在每个 iteration 训练的时候，文本部分的 Encoder 模型要 forward 2次，一次是输入完整的文本做图文匹配任务，一次是输入 mask 之后的文本做完形填空任务。但是 CoCa 文本部分的 Decoder 模型只需要 forward 1次，即可同时计算对比学习的损失和图片字幕的损失。</p>
<p>即：a simple decoupled decoder design where we split the decoder into unimodal and multimodal components</p>
<p><strong>Pooler:</strong><br />
在文本端最后加入 [cls] token ，来作为 text representation</p>
<p>在图片端，作者认为 more visual tokens 更适合 multimodal understanding tasks ，因为可以提供 region-level features 。<br />
所以这里使用了 <strong>Attentional Pooler</strong> ，一种 task-specific attentional pooling 的聚合方法：在 encoder 之后，加入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">n_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 个可以学习的 query token，然后对 encoder output 做 attention 。</p>
<ul>
<li>对于生成任务： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub><mo>=</mo><mn>256</mn></mrow><annotation encoding="application/x-tex">n_{query}=256</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span></li>
<li>对于对比学习任务： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n_{query}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></li>
</ul>
<p>这些 query token 还可以变相地被看作 adaptor 。</p>
<h2 id="contrastive-captioners-for-downstream-tasks"><a class="markdownIt-Anchor" href="#contrastive-captioners-for-downstream-tasks"></a> Contrastive Captioners for Downstream Tasks</h2>
<p><img src="https://pic1.zhimg.com/80/v2-ba7743d56dcfd61c13883602d0423610_720w.webp" alt="" /></p>
<p>第1种是零样本迁移 (Zero-Shot Transfer) 任务，具体包括 Zero-Shot Image Classification, Zero-Shot Image-Text Cross-Retrieval, Zero-Shot Video-Text Cross-Retrieval。</p>
<p>第2种是冻住编码器特征做评估 (Frozen-feature Evaluation) 任务，CoCa 模型训练好之后会得到一个 backbone encoder，对于不同任务只是 pooler 的 query 不一样。也就是只需要重新学 query token 即可。</p>
<p>第3种是视频动作识别 (Video Action Recognition) 任务，CoCa 模型分别将每一帧输入共享图像编码器，如下图6所示。CoCa 模型额外使用交叉熵损失函学习了一个 attentional_pooler，它的输入是1个 query 和所有的空间和时间特征 token。</p>
<p><img src="https://pic4.zhimg.com/80/v2-01c2da4ea60d7fcd190a0d5a48649dab_720w.webp" alt="" /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/03/MySQL%20info/mysql%20%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/03/MySQL%20info/mysql%20%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">mysql 事务 Transaction</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-03 22:49:21" itemprop="dateCreated datePublished" datetime="2021-03-03T22:49:21-08:00">2021-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>定义：</p>
<ul>
<li>是一组操作的集合，是一个不可分割的工作单位。</li>
<li>会把所有的操作作为一个整体一起向系统提交或者撤销；即这些操作要么同时成功，要么同时失败。</li>
</ul>
<p>只有使用了 <strong>Innodb</strong> 数据库引擎的数据库或表才支持事务。</p>
<p>流程：</p>
<ol>
<li>开启事务</li>
<li>执行事务内部操作，如果发成异常，则回滚事务</li>
<li>提交事务，此时数据库才会更新，而且是一次性更新所有事务内部的操作</li>
</ol>
<p>好处：保证了数据的完整性和一致性</p>
<h2 id="回滚"><a class="markdownIt-Anchor" href="#回滚"></a> 回滚</h2>
<h3 id="查看-设置事务提交方式"><a class="markdownIt-Anchor" href="#查看-设置事务提交方式"></a> 查看 / 设置事务提交方式</h3>
<p>查看提交方式，默认为自动提交。所有指令都直接提交，所以无法回滚。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@autocommit;</span><br><span class="line">&gt;&gt;&gt; 1</span><br></pre></td></tr></table></figure>
<p>修改提交方式为手动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`SET @@autocommit=0;`</span><br></pre></td></tr></table></figure>
<p>有两种方式支持回滚</p>
<ol>
<li>设置提交方式为 <strong>手动</strong>，无论做出什么修改都要<code>commit</code>/<code>rollback</code>，并且可以多次回滚。</li>
<li>开启事务方式，支持回滚一次。</li>
</ol>
<h3 id="手动提交事务"><a class="markdownIt-Anchor" href="#手动提交事务"></a> 手动提交事务</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@autocommit;</span><br><span class="line">&gt;&gt;&gt; 1</span><br><span class="line"></span><br><span class="line"># 设置手动回滚</span><br><span class="line">SET @@autocommit=0;</span><br><span class="line"></span><br><span class="line"># 提交事务</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line"># ... 一些sql操作命令，数据是改变的，但是还没有提交</span><br><span class="line"></span><br><span class="line"># 回滚事务</span><br><span class="line">ROLLBACK;</span><br></pre></td></tr></table></figure>
<p>这个 ROLLBACK 不会清楚缓存，可以回滚多次。<br />
这种方式不会自动修改数据，必须要 COMMIT，或者 ROLLBACK。</p>
<h3 id="自动提交模式下开启事务"><a class="markdownIt-Anchor" href="#自动提交模式下开启事务"></a> 自动提交模式下开启事务</h3>
<p><code>START TRANSACTION;</code>或者<code>BEGIN;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@autocommit;</span><br><span class="line">&gt;&gt;&gt; 1</span><br><span class="line"></span><br><span class="line"># 开启事务</span><br><span class="line">START TRANSACTION;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ... 一些sql操作命令，数据改变，但是还没有提交</span><br><span class="line"></span><br><span class="line"># 回滚事务，此次生效，回滚成功</span><br><span class="line">ROLLBACK;</span><br><span class="line"></span><br><span class="line"># 提交事务，和上面的回滚事务只能选一个</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line"># ... 一些sql操作命令，数据改变</span><br><span class="line"></span><br><span class="line"># 第二次回滚事务，此次无法生效，缓存被清除了</span><br><span class="line">ROLLBACK;</span><br></pre></td></tr></table></figure>
<p>也就是说这种方式，仍然是自动修改数据，但是支持回滚，但是只能回滚一次，其实就是事务结束了。<br />
如果指定<code>START TRANSACTION</code>，则会立即启动一个事务，并且必须通过显式<code>COMMIT</code>或<code>ROLLBACK</code>来结束该事务。</p>
<h2 id="事务四大特性acid"><a class="markdownIt-Anchor" href="#事务四大特性acid"></a> 事务四大特性（ACID）</h2>
<ol>
<li>原子性（Atomicity）：事务中的操作是不可分割的，是一个原子。要么全成功，要么全失败。</li>
<li>一致性（Consistency）：事务完成前后，数据需要一致，比如金额总额一致。</li>
<li>隔离性（Isolation）：两个操作并发执行时，相互不影响。</li>
<li>持久性（Durability）：事务一旦提交或者回滚对数据库的改变就是永久的。</li>
</ol>
<h2 id="并发事务引发的问题"><a class="markdownIt-Anchor" href="#并发事务引发的问题"></a> 并发事务引发的问题</h2>
<p>博客：<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/concurrency-problems-in-dbms-transactions/">Concurrency problems in DBMS Transactions</a><br />
两个事务 A，B在同时操作一个表时，引发的问题。</p>
<p>分类：</p>
<ul>
<li>脏读(Temporary Update Problem / Dirty read problem)：一个事务读取到<strong>另一个事务还没有提交</strong>的数据。</li>
<li>不可重复读(Unrepeatable Read Problem)：一个事务先后读取同一条数据，但是两次读取的记录不同。</li>
<li>幻读(Phantom Read Problem)：一个事务查询数据时，没有查询到数据行，然后决定插入。（这时另一个并发进程在执行插入）但是在插入时，发现已经存在。</li>
</ul>
<h2 id="事务隔离界别"><a class="markdownIt-Anchor" href="#事务隔离界别"></a> 事务隔离界别</h2>
<p>为了解决事务引发的问题</p>
<table>
<thead>
<tr>
<th>隔离级别名称</th>
<th></th>
<th>会出现脏读</th>
<th>会出现不可重复读</th>
<th>会出现幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td>Read Uncommitted</td>
<td>可以读到其他事务<strong>修改过但是还没有提交</strong>的数据</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>Read Committed</td>
<td>只能读到其他事务<strong>已经提交</strong>的数据</td>
<td></td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>Repeatable Read <br>(<strong>Default</strong>)</td>
<td>事务B只能在事务A修改并提交过数据后，自己也提交事务后，<br> 才能读到事务B修改的数据。</td>
<td></td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td>Serializable</td>
<td>事务之间通过一个接一个串行地执行<br>通过加锁实现（读锁和写锁）</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="命令"><a class="markdownIt-Anchor" href="#命令"></a> 命令</h3>
<p>查看事务隔离级别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@TRANSACTION_ISOLATION</span><br></pre></td></tr></table></figure>
<p>设置事务隔离级别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SET [GLOBAL | SESSION] TRANSACTION</span><br><span class="line">    ISOLATION LEVEL [LEVEL]</span><br><span class="line"></span><br><span class="line">LEVEL: &#123;</span><br><span class="line">     REPEATABLE READ</span><br><span class="line">   | READ COMMITTED</span><br><span class="line">   | READ UNCOMMITTED</span><br><span class="line">   | SERIALIZABLE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SESSION</code>：</p>
<ul>
<li>对当前会话的所有后续的事务有效</li>
<li>该语句可以在已经开启的事务中间执行，但不会影响当前正在执行的事务</li>
<li>如果在事务之间执行，则对后续的事务有效。</li>
</ul>
<p><code>GLOBAL</code>：全局级别，对全局所有的子视图都会被修改，但是已经存在的视图不会被修改。<br />
不指定的话，则设置当前视图下的下一个没开始的事务。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/03/MySQL%20info/mysql%20%E7%BA%A6%E6%9D%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/03/MySQL%20info/mysql%20%E7%BA%A6%E6%9D%9F/" class="post-title-link" itemprop="url">mysql DDL 约束</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-03 22:49:21" itemprop="dateCreated datePublished" datetime="2021-03-03T22:49:21-08:00">2021-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mysql约束"><a class="markdownIt-Anchor" href="#mysql约束"></a> mysql约束</h1>
<p>是什么：是作用于表中字段上的规则，用于限制存储在表中的数据，属于 DDL 的限制操作。<br />
为什么：保证数据的正确，有效，完整</p>
<p>分类：</p>
<ol>
<li>非空约束：管理的字段不能存储null值。<code>sname varchar(10) NOT NULL</code></li>
<li>唯一性约束：存储的字段值不能有重复值，但是可以存储null。<code>email varchar(20) UNIQUE</code>；唯一但是可以为空，并且可以有多个空值，(空和空不相等)。</li>
<li>主键约束 <code>sid int PRIMARY KEY</code> ，默认非空且唯一</li>
<li>外键约束：要求外键字段值应该来源于关联表的主键的值，但是可以存储null值。</li>
<li>默认约束：如果没有指定字段值，则采用默认值 <code>DEFAULT</code></li>
<li>检查约束（8.0.16版本后）：保证满足某一条件 <code>CHECK</code></li>
<li>自增：<code>AUTO_INCREMENT</code></li>
</ol>
<h2 id="设置方法"><a class="markdownIt-Anchor" href="#设置方法"></a> 设置方法</h2>
<ol>
<li>建表时直接设置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE stu</span><br><span class="line">(</span><br><span class="line">    `id`     int PRIMARY KEY AUTO_INCREMENT COMMENT &#x27;主键&#x27;,</span><br><span class="line">    `name`   varchar(10) NOT NULL UNIQUE COMMENT &#x27;姓名&#x27;,</span><br><span class="line">    `age`    int CHECK ( age &gt; 0 and age &lt;= 120 ),</span><br><span class="line">    `status` char(1) DEFAULT &#x27;1&#x27; COMMENT &#x27;状态&#x27;,</span><br><span class="line">    `gender` char(1) COMMENT &#x27;性别&#x27;</span><br><span class="line">) comment &#x27;用户表&#x27;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>建表时候在约束区进行设置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user2(</span><br><span class="line">    id INT,</span><br><span class="line">    `name` VARCHAR(20),</span><br><span class="line">    PRIMARY KEY (id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>建后直接设置
<ul>
<li>修改 name 的数据类型和约束 -&gt; <code>modify</code></li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE stu MODIFY 字段名称 varchar(10) NOT NULL;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 name 的名称，数据类型和约束 -&gt; <code>change</code></li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `表名称` CHANGE 旧字段名称 新字段名称 字段类型 约束;</span><br></pre></td></tr></table></figure>
和 <code>modify</code> 区别只在于能够修改字段名称。
<ul>
<li>增加外键约束：</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `表名称` ADD UNIQUE (`字段名`)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="check"><a class="markdownIt-Anchor" href="#check"></a> Check</h2>
<p><strong>Mysql 并不是强制要求的，即并不支持这个操作</strong>； PostgreSQL 支持。<br />
如果非要设置这个检查约束，则见 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangtianze/p/6700244.html">MySQL关于check约束无效的解决办法</a> 。</p>
<h3 id="attribute-based-check"><a class="markdownIt-Anchor" href="#attribute-based-check"></a> Attribute-Based Check</h3>
<p>在声明变量后使用这个 Check 选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Sells</span><br><span class="line">(</span><br><span class="line">    bar   CHAR(20),</span><br><span class="line">    beer  CHAR(20) CHECK ( beer IN</span><br><span class="line">                           (SELECT name FROM Beers)),</span><br><span class="line">    price REAL CHECK ( price &lt;= 5.00 )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><code>beer</code>部分中使用了子查询作为 check 的部分 ，对象可以是本表，或者其他的外部表 。</p>
<p>只有在数据被插入或者更新时，才会 check 。</p>
<p>如果在 Beers 表格中有个元组被删除了，那么这个 check 约束是不会报错的，是不会自动检查的，和外键不同。</p>
<h3 id="tuple-based-check"><a class="markdownIt-Anchor" href="#tuple-based-check"></a> Tuple-Based Check</h3>
<p><code>CHECK</code> 还可以用来约束多个字段，即直接对整个 tuple 进行约束：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Sells</span><br><span class="line">(</span><br><span class="line">    bar   CHAR(20),</span><br><span class="line">    beer  CHAR(20),</span><br><span class="line">    price REAL,</span><br><span class="line">    CHECK (bar = &#x27;Joe&#x27; OR price &lt;= 5.00)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="主键约束"><a class="markdownIt-Anchor" href="#主键约束"></a> 主键约束</h2>
<ul>
<li>设置方法见上文</li>
</ul>
<h3 id="删除方法"><a class="markdownIt-Anchor" href="#删除方法"></a> 删除方法</h3>
<p><code>ALTER TABLE user1 DROP PRIMARY KEY;</code></p>
<p>删除有两种操作，<code>DELETE</code> 和 <code>TRUNCATE</code> 的区别：</p>
<ul>
<li><code>DELETE</code> 删除表中的数据，不重置 <code>AUTO_INCREMENT</code> 的值</li>
<li><code>TRUNCATE</code> 摧毁表，重建表， <code>AUTO_INCREMENT</code> 重置为 1</li>
</ul>
<p>如果想自定义id的值,可以使用下面的sql进行设置：<br />
<code>ALTER TABLE 表名 AUTO_INCREMENT=起始值;</code></p>
<h3 id="联合约束"><a class="markdownIt-Anchor" href="#联合约束"></a> 联合约束</h3>
<p>联合多个字段设置为主键约束</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user4(</span><br><span class="line">    id INT,</span><br><span class="line">    `name` VARCHAR(20),</span><br><span class="line">    PRIMARY KEY (id,`name`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- 保证id和name字段不为空,然后联合判断唯一性</span><br><span class="line">INSERT INTO user4 VALUES(1,&#x27;tom&#x27;); -- 正常插入</span><br><span class="line">INSERT INTO user4 VALUES(2,&quot;tom&quot;); -- 正常插入</span><br><span class="line">INSERT INTO user4 VALUES(1,&quot;rose&quot;); -- 正常插入</span><br><span class="line">INSERT INTO user4 VALUES(2,&quot;rose&quot;); -- 正常插入</span><br><span class="line">INSERT INTO user4 VALUES(1,&quot;tom&quot;); -- 插入异常:Duplicate entry &#x27;1-tom&#x27; for key &#x27;PRIMARY&#x27;</span><br><span class="line">INSERT INTO user4 VALUES(NULL,&quot;jack&quot;); -- 插入异常:Column &#x27;id&#x27; cannot be null</span><br><span class="line">INSERT INTO user4 VALUES(3,NULL); -- 插入异常:Column &#x27;name&#x27; cannot be null</span><br></pre></td></tr></table></figure>
<p>联合 unique：<br />
<code>create table Test (a int, b int, unique(a, b));</code></p>
<h1 id="外键约束"><a class="markdownIt-Anchor" href="#外键约束"></a> 外键约束</h1>
<p>被外键索引的主表的键必须要是：1.PRIMARY KEY 或者 2.UNIQUE 。<br />
给 两张表 建立连接，从而保证数据一致性和完整性。<br />
<strong>子表</strong>的外键关联了<strong>父表</strong>的主键。</p>
<p>有两种冲突情况：</p>
<ol>
<li>插入外键表格的数据，主键表中没有相对应的数据。 -》 数据库会直接拒绝</li>
<li>当删除主键表格中的数据时，相连接的外键数据会变成无主的元组。<br />
可以设置约束，用来实现：如果子表有外键关联一个父表，那么父表：
<ol>
<li>无法随意删除其记录（默认）</li>
<li>删除后子表设置 Null</li>
<li>删除后子表设置默认值</li>
<li>子表也删除/更新相应记录。</li>
</ol>
</li>
</ol>
<p>建立：</p>
<ol>
<li>创建时在声明完变量，table括号内，重起一行添加：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONSTRAINT 外键约束对象名 FOREIGN KEY (外键字段名) REFERENCES 一方表/主表(主键字段名)</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE student_class(</span><br><span class="line">    `id` int PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    `studentid` int not null,</span><br><span class="line">    `classid` int not null,</span><br><span class="line">    &lt; CONSTRAINT fkstudentid &gt; FOREIGN KEY (studentid) REFERENCES student(id),</span><br><span class="line">    &lt; CONSTRAINT fkcourseid &gt; FOREIGN KEY (classid) REFERENCES course(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><code>&lt; CONSTRAINT fkstudentid &gt;</code> 可以不加，或者使用 <code>beer CHAR(20) REFERENCES Beers(name)</code> 声明后直接建立外键。</p>
<p>同时也支持多个字段建立外键：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table F(</span><br><span class="line">    a int, b int,</span><br><span class="line">    foreign key (a, b)references P (a, b)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>建后直接设置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE 多方表</span><br><span class="line">ADD CONSTRAINT 外键约束对象名 FOREIGN KEY(外键字段名)</span><br><span class="line">REFERENCE 一方表/主表(主键字段)</span><br></pre></td></tr></table></figure>
<p>删除外键</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE 多方表</span><br><span class="line">DROP FOREIGN KEY 外键约束对象名;</span><br></pre></td></tr></table></figure>
<h2 id="外键约束的删除和更新行为"><a class="markdownIt-Anchor" href="#外键约束的删除和更新行为"></a> 外键约束的删除和更新行为</h2>
<ul>
<li>NO ACTION / RESTRICT ：当在「一方表/父表」中更新/删除对应记录时候，首先检查是否有外键，如果有，则「不允许更新」。</li>
<li>CASCADE：在「一方表/父表」中「更新/删除」对应记录时候，首先检查是否有外键，如果有，则也会「更新/删除」子表记录。</li>
<li>SET NULL：在「一方表/父表」中「删除」对应记录时候，首先检查是否有外键，如果有，则会将「子表」中的对应值设置为 null。</li>
<li>SET DEFAULT：在「一方表/父表」中「删除」对应记录时候，首先检查是否有外键，如果有，则会将「子表」中的对应值设置为「DEFAULT 值」（Innodb 不支持）。</li>
</ul>
<p>设置方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE 子表名</span><br><span class="line">ADD CONSTRAINT 外键约束对象名</span><br><span class="line">FOREIGN KEY (外键字段) REFERENCES 一方表/父表名 (主表字段名)</span><br><span class="line">ON [UPDATE, DELETE] [更新行为名称 e.g. CASCADE]</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE Sells (</span><br><span class="line">    bar CHAR(20),</span><br><span class="line">    beer CHAR(20),</span><br><span class="line">    price REAL,</span><br><span class="line">    FOREIGN KEY(beer) REFERENCES Beers(name)</span><br><span class="line">    ON DELETE SET NULL ON UPDATE CASCADE );</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/03/MySQL%20info/mysql%20DDL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/03/MySQL%20info/mysql%20DDL/" class="post-title-link" itemprop="url">mysql DDL Data Definition Language</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-03 22:44:21" itemprop="dateCreated datePublished" datetime="2021-03-03T22:44:21-08:00">2021-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>DDL (Data Definition Language) 数据库定义语言<br />
用于定义SQL模式、基本表、视图和索引的创建和撤消操作，在建表的时候使用。</p>
<ul>
<li>CREATE</li>
<li>ALTER</li>
<li>DROP</li>
<li>TRUNCATE</li>
<li>COMMIT</li>
<li>RENAME</li>
</ul>
<h3 id="打开与退出"><a class="markdownIt-Anchor" href="#打开与退出"></a> 打开与退出</h3>
<p>命令行：输入 <code>mysql -u root -p</code>，还可以选添 <code>-P 3306</code> 来设置端口号<br />
进入后：<code>quit</code>退出</p>
<h3 id="数据库管理命令"><a class="markdownIt-Anchor" href="#数据库管理命令"></a> 数据库管理命令</h3>
<ul>
<li>所有的表文件都存放在data文件夹中</li>
<li>查看所有数据库名：<code>show databases;</code></li>
<li>information_schema 存放在内存中，每次都会自动销毁</li>
<li>创建一个数据库：
<ol>
<li><code>create database [if not exists] 数据库名 [default charset utf8mb4];</code><br />
<code>[if not exists]</code>是可选择的，用来防止报错。<br />
<code>[default charset utf8]</code>为指定的默认字符集。</li>
<li>目录下手动新建文件夹也可以</li>
</ol>
</li>
<li>删除一个数据库：<code>drop database 数据库名;</code><br />
如果表存在则删除表（用于重新创建）：<code>drop table if exists suspects;</code></li>
<li>使用数据库 <code>use database 数据库名;</code></li>
<li>查询当前的数据库 <code>select database();</code> 注意加个括号</li>
</ul>
<h3 id="表文件管理命令"><a class="markdownIt-Anchor" href="#表文件管理命令"></a> 表文件管理命令</h3>
<ul>
<li>
<p>查看指定的数据库下所有的表文件名：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use 数据库名;</span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在指定数据库下创建表文件：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use 数据库名;</span><br><span class="line">create table 表文件名(</span><br><span class="line">    字段名 数据类型名 [comment 字段注释],</span><br><span class="line">    字段名 数据类型名  &lt;--最后一个字段不要加&quot;,&quot;</span><br><span class="line">) [comment 表注释];</span><br></pre></td></tr></table></figure>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database bjpowernode;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use bjpowernode;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table stu(</span><br><span class="line">    -&gt; sid int,</span><br><span class="line">    -&gt; sname varchar(10),</span><br><span class="line">    -&gt; age int</span><br><span class="line">    -&gt; );</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure>
<p>在这里面，字符串类型使用 <strong>varchar(5)</strong>，括号内放置最大字符长度。<br />
可以使用<code> [comment 字段注释]/[comment 表注释]</code> 进行注释。</p>
  <details>
  <summary>详细的 char-us-varchar，各种数值类型对比</summary>
<table>
<thead>
<tr>
<th style="text-align:center">Value</th>
<th style="text-align:center">CHAR(4)</th>
<th style="text-align:center">CHAR(4)-Storage</th>
<th style="text-align:center">VARCHAR(4)</th>
<th style="text-align:center">VARCHAR(4)-Storage</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">“”</td>
<td style="text-align:center">’    ’</td>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">&quot;</td>
<td style="text-align:center">1 byte</td>
</tr>
<tr>
<td style="text-align:center">‘ab’</td>
<td style="text-align:center">'ab  ’</td>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">‘ab’</td>
<td style="text-align:center">3 bytes</td>
</tr>
<tr>
<td style="text-align:center">‘abcd’</td>
<td style="text-align:center">‘abcd’</td>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">‘abcd’</td>
<td style="text-align:center">5 bytes</td>
</tr>
<tr>
<td style="text-align:center">‘abcdefgh’</td>
<td style="text-align:center">‘abcd’</td>
<td style="text-align:center">4 bytes</td>
<td style="text-align:center">‘abcd’</td>
<td style="text-align:center">5 bytes</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">Type</th>
<th style="text-align:left">Storage</th>
<th style="text-align:left">Minimum Value</th>
<th style="text-align:left">Maximum Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">(Bytes)</td>
<td style="text-align:left">(Signed/Unsigned)</td>
<td style="text-align:left">(Signed/Unsigned)</td>
</tr>
<tr>
<td style="text-align:left">TINYINT</td>
<td style="text-align:left">1</td>
<td style="text-align:left">-128</td>
<td style="text-align:left">127</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">255</td>
</tr>
<tr>
<td style="text-align:left">SMALLINT</td>
<td style="text-align:left">2</td>
<td style="text-align:left">-32768</td>
<td style="text-align:left">32767</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">65535</td>
</tr>
<tr>
<td style="text-align:left">MEDIUMINT</td>
<td style="text-align:left">3</td>
<td style="text-align:left">-8388608</td>
<td style="text-align:left">8388607</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">16777215</td>
</tr>
<tr>
<td style="text-align:left">INT</td>
<td style="text-align:left">4</td>
<td style="text-align:left">-2147483648</td>
<td style="text-align:left">2147483647</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">4294967295</td>
</tr>
<tr>
<td style="text-align:left">BIGINT</td>
<td style="text-align:left">8</td>
<td style="text-align:left">-9223372036854775808</td>
<td style="text-align:left">9223372036854775807</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">18446744073709551615</td>
</tr>
</tbody>
</table>
  </details>
<ul>
<li>数据类型：
<ul>
<li>CHAR(n) 存储时右边会使用空格进行占位</li>
<li>VARCHAR() 可变长度字符串，不进行占位，存储时会将长度存储为 prefix</li>
<li>INT</li>
<li>FLOAT / REAL</li>
<li>YEAR: YYYY</li>
<li>TIME: HH:MM:SS</li>
<li>DATE: YYYY-MM-DD</li>
<li>DATETIME: YYYY-MM-DD HH:MM:SS<br />
比如：<code>insert into test values('2016-1-1', '2016- 1-1 3:10:10')</code>，分别对应 <code>date</code> 和 <code>datetime</code> 。</li>
<li>TIMESTAMP: YYYY-MM-DD HH:MM:SS 描述的时间在不同时区索引出来可能是不同的，动态计算出对应时区时间。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>删除表文件： <code>drop table 表文件名;</code></p>
</li>
<li>
<p>查看表文件中的字段信息： <code>desc 表文件名称;</code></p>
</li>
<li>
<p>查看表文件中更详细的信息/创建的命令： <code>show create table 表文件名称;</code></p>
</li>
<li>
<p>为表文件添加字段： <code>alter table 表文件名 add 新字段名 数据类型名称 &lt;attribute declaration&gt;;</code></p>
</li>
<li>
<p>修改数据类型： <code>alter table 表文件名 modify 字段名 新数据类型;</code></p>
</li>
<li>
<p>删除表文件字段： <code>alter table 表文件名 drop 字段名;</code></p>
</li>
</ul>
<h3 id="表文件数据行管理命令"><a class="markdownIt-Anchor" href="#表文件数据行管理命令"></a> 表文件数据行管理命令</h3>
<ul>
<li>插入命令：要求mysql服务器向指定的表文件中添加数据行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into 表文件名 (字段名1,字段名2,字段名3)</span><br><span class="line">values(值1,值2,值3);        &lt;-字符串和日期的值使用单引号扩起来</span><br></pre></td></tr></table></figure>
<ul>
<li>批量插入：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insert into 表文件名(字段1,字段2,字段3)</span><br><span class="line">values</span><br><span class="line">(值1,值2,值3),</span><br><span class="line">(值1,值2,值3),</span><br><span class="line">(值1,值2,值3);</span><br></pre></td></tr></table></figure>
<ul>
<li>简化版本插入命令：<code>insert into 表文件名 values(值1,值2,值3);</code><br />
如果插入数据时，每一个字段都可以赋值，此时插入命令不需要指定字段名，数据顺序此时要与表文件字段顺序相同</li>
<li>删除命令：
<ol>
<li><code>delete from 表文件名;</code>删除所有数据</li>
<li><code>delete from 表文件名 where 判断条件;</code>删除满足条件的数据行数据。判断数据一般放置关系条件或者逻辑条件。(等于使用单等号=)</li>
</ol>
</li>
<li>更新命令：要求mysql服务器将指定的表文件数据进行更新
<ol>
<li>对所有数据行<code>update 表文件名 set 字段名1=值,字段名2=值 [WHERE 条件];</code></li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update stu set age=age+3;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 2  Changed: 2  Warnings: 0</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>对指定数据行<code>update 表文件名 set 字段名1=值,字段名2=值 where 判断条件;</code>使用where来选择</li>
</ol>
</li>
<li>数据行复制命令：<code>insert into B select * from A</code>可以将表A中的数据行复制到表B(要求表A与表B字段结构完全一致)</li>
<li>表文件备份命令：<code>create table B select * from A</code>将表A进行一次备份，备份生成表B</li>
</ul>
<h3 id="查询命令-dql"><a class="markdownIt-Anchor" href="#查询命令-dql"></a> 查询命令 DQL</h3>
<ul>
<li>查询命令：<code>select * from 表文件名;</code>要求mysql服务器将指定的表文件数据进行展示</li>
<li>语法：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT 字段列表</span><br><span class="line">FROM 表名</span><br><span class="line">WHERE 条件列表</span><br><span class="line">GROUP BY 分组字段列表</span><br><span class="line">HAVING 分组后条件列表</span><br><span class="line">ORDER BY 排序字段列表</span><br><span class="line">LIMIT 分页参数</span><br></pre></td></tr></table></figure>
<h3 id="mql执行计划explain"><a class="markdownIt-Anchor" href="#mql执行计划explain"></a> mql执行计划(explain)</h3>
<ol>
<li>命令格式：explain 查询命令</li>
<li>命令作用：展示当前查询得到的结果是否通过索引来进行定位</li>
<li>例子：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM emp WHERE ename=&#x27;smith&#x27;</span><br><span class="line">--&gt; EXPLAIN SELECT * FROM emp WHERE ename=&#x27;smith&#x27;</span><br><span class="line">--&gt; type: ref(索引查询) rows:1(查询次数)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>判断：type属性表示执行效率。<br />
<strong>all</strong>(对所有数据行进行遍历)<br />
<strong>type</strong>(WHERE对所有数据行进行遍历，SELECT从索引中抓取)<br />
<strong>range</strong>(WHERE直接通过索引来查询，但是不稳定，因为字段变化时会导致失效)<br />
<strong>ref</strong>(WHERE直接通过索引来查询，一次只得到一行数据 --&gt; 该行数据没有重复)<br />
<strong>const</strong>(通过主键索引来进行定位)</li>
</ol>
<p><strong>mysql如果发现通过索引得到数据行数&gt;1/3是，会自动放弃索引查询，type依然是all</strong></p>
<h3 id="视图"><a class="markdownIt-Anchor" href="#视图"></a> 视图</h3>
<ol>
<li>定义：Mysql对象，用于存储 <strong>查询语句</strong> 。</li>
<li>目的：提高查询语句使用效率，可复用性。</li>
<li>命令：<code>CREATE VIEW 视图对象名 AS 查询语句;</code></li>
<li>调用：<code>SELECT * FROM 视图对象名;</code>，还可以通过视图对象关联表文件数据行进行插入，删除，更新操作。</li>
<li>作用：<strong>隐藏业务中涉及表关系，开发人员通过视图进行操作时不会知道具体操作的表，提高了安全性。</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- 创建视图</span><br><span class="line">CREATE VIEW CanDrink AS</span><br><span class="line">SELECT distinct drinker, beer</span><br><span class="line">FROM Frequents, Sells</span><br><span class="line">WHERE Frequents.bar = Sells.bar;</span><br><span class="line"></span><br><span class="line">-- 使用视图</span><br><span class="line">select beer from CanDrink</span><br><span class="line">where drinker = &#x27;Bill&#x27;;</span><br></pre></td></tr></table></figure>
<p>DBMS 会将视图先存储起来，然后交给下面的查询语句继续调用。<br />
具体地，DBMS 并 <strong>不是存储了视图表格</strong>，而是存储了他的 <strong>查询语句</strong>（有点像关系代数），在后面调用视图时，会自动将该语句进行内嵌。</p>
<blockquote>
<p>The queries defining any views used by the query are also replaced by their algebraic equivalents, and “spliced into” the expression tree for the query.</p>
</blockquote>
<br>
<p><strong>What Happens When We Query a View ?</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-- build view</span><br><span class="line">CREATE VIEW LA- view AS</span><br><span class="line">SELECT buyer, seller, product, store</span><br><span class="line">FROM Person, Purchase</span><br><span class="line">WHERE Person.city = ‘LA’</span><br><span class="line">  AND Person.name = Purchase.buyer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- query on view</span><br><span class="line">SELECT name, LA-view.store</span><br><span class="line">FROM LA-view, Product</span><br><span class="line">WHERE LA-view.product = Product.name AND Product.category = &#x27;shoes&#x27;</span><br></pre></td></tr></table></figure>
<p>底层的实现为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT name, Purchase.store</span><br><span class="line">FROM Person, Purchase, Product</span><br><span class="line">WHERE   Person.city = &#x27;LA&#x27; AND</span><br><span class="line">        Person.name = Purchase.buyer AND</span><br><span class="line">        Purchase.product = Product.name AND</span><br><span class="line">        Product.category = &#x27;shoes&#x27;;</span><br></pre></td></tr></table></figure>
<br>
<p>同时，内嵌之后，DBMS 会自动优化组合起来的查询语句，实现查询加快的效果。<br />
<img src="https://pica.zhimg.com/80/v2-ab12768d5bd8a5992b05bfad83634406_1440w.png" alt="" /></p>
<p>主要是两个步骤：</p>
<ol>
<li>将 select 操作向底层推，这样需要 join 的条目就少了</li>
<li>将 project 操作向上推，先运算，再投影</li>
</ol>
<h3 id="存储引擎"><a class="markdownIt-Anchor" href="#存储引擎"></a> 存储引擎</h3>
<ol>
<li>定义：是mysql服务器对表文件内容的管理方式，目前主要采用INNODB，Myisam.</li>
<li>管理命令：
<ul>
<li>查看支持存储引擎种类：<code>show engines</code>，默认使用innodb引擎</li>
<li>修改引擎，<code>my.cnf文件</code>，在<code>/etc</code>配置文件夹下，<code>default-storage-engine=INNODB</code></li>
<li>设置表文件呢依赖的存储引擎：<code>alter TABLE 表名 ENGINE=存储引擎</code></li>
</ul>
</li>
<li>存储引擎特征：
<ul>
<li>Myisam：
<ul>
<li>修改表时，不会备份。提高效率，操作后无法取消本操作。</li>
<li>使用三个表存储信息：<strong>test1.frm</strong>储存表文件字段信息，<strong>test1.myd</strong>储存表文件数据行信息，<strong>test1.myi</strong>存储表文件字段关联的索引信息。</li>
</ul>
</li>
<li>INNODB：
<ul>
<li>对表内容修改时，首先进行一次备份，因此效率较慢。</li>
<li>但是执行完毕后，可以使用备份取消当前操作，增加安全性。</li>
<li>使用一个文件<strong>test1.frm</strong>存储所有信息。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="事物transaction"><a class="markdownIt-Anchor" href="#事物transaction"></a> 事物(transaction)</h3>
<ol>
<li>介绍：用于对当前表文件备份进行管理。</li>
<li>命令格式：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start transaction #通过服务器提供一个事物对象来管理备份接下来的操作</span><br><span class="line">delete from emp where deptno=30 #生成emp.bak</span><br><span class="line">delete from dept where deptno=30 #生成emp.bak</span><br><span class="line">ROLLBACK #取消本次操作</span><br><span class="line">COMMIT #提交操作：将本次操作的所有备份信息删除</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/03/MySQL%20info/mysql%20%E7%B4%A2%E5%BC%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/03/MySQL%20info/mysql%20%E7%B4%A2%E5%BC%95/" class="post-title-link" itemprop="url">mysql 索引</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-03 22:44:21" itemprop="dateCreated datePublished" datetime="2021-03-03T22:44:21-08:00">2021-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Coding/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>mysql索引(index)</strong></p>
<p>不加索引的时候，在匹配某个属性时，是一个一个进行匹配扫描的。</p>
<ul>
<li>优点
<ul>
<li>使用平衡树来存储数据，降低查询时间 -&gt; io 成本</li>
<li>降低数据排序的成本 -&gt; cpu 成本</li>
</ul>
</li>
<li>缺点
<ul>
<li>降低更新表的效率：<br />
增删改数据都会改变平衡树各节点中的索引数据内容，破坏树结构。<br />
因此，在每次数据改变时， DBMS必须去重新梳理树（索引）的结构以确保它的正确，</li>
<li>索引列额外占用磁盘空间 -&gt; b+树</li>
</ul>
</li>
</ul>
<p>索引命令语法：</p>
<ul>
<li>添加索引：<code>CREATE INDEX 索引名 ON 表名(字段, ...)</code></li>
<li>查看索引：<code>SHOW INDEX FROM 表名</code><br />
这时会看到三个索引，因为服务器会默认为<strong>主键约束</strong>，<strong>外键约束</strong>，<strong>唯一性约束</strong>绑定索引。</li>
<li>删除索引：<code>DROP INDEX 索引名 ON 表名</code>、</li>
</ul>
<p>常用的存储索引的数据结构：hashmap , b+ tree , R-tree , Ful-text</p>
<p>索引分类：</p>
<ol>
<li>主键索引：默认自动创建，唯一</li>
<li>唯一索引：默认自动创建，可以有多个</li>
<li>常规索引：为了快速定位数据，可以有多个</li>
<li>全文索引<code>FULLTEXT</code>：查找文本关键值，而不是比较索引值，可以有多个</li>
</ol>
<p>索引类型：</p>
<ul>
<li>
<p>聚集索引（Clustered Index）：</p>
<ul>
<li>表中必须有，并且只能有一个</li>
<li>将数据库表的数据行按照指定 search key 的顺序进行排序并存储</li>
<li>将数据存储和索引放在一起，其对应的树的 <strong>叶子节点指向物理数据</strong>，非叶子节点就是索引</li>
<li>加了索引之后，整个表就变成了一种 平衡树 结构。换句话说，就是整个表就变成了一个索引，存储顺序也发生了改变，即「聚集索引」。这就是为什么一张表只能有一个主键，因为只能有一种物理存储方式。</li>
<li>[Coding, MySQL] 会自动创建聚集索引：
<ol>
<li>primary key if exists</li>
<li>otherwise 1st unique key</li>
<li>if no unique key , use the hidden row ID (we cant see)</li>
</ol>
</li>
</ul>
</li>
<li>
<p>二级索引/非聚集索引（Secondary / Non-Clustered Index），也就是我们平时经常提起和使用的 常规索引。</p>
<ul>
<li>可以没有，也可以是多个</li>
<li>叶子节点指向的是对应的主键值</li>
</ul>
</li>
</ul>
<p>两种索引方式的都是采用平衡树作为数据结构。索引树结构中各节点的值来自于表中的索引字段。<br />
如果给表中多个字段加上索引， 那么就会出现多个独立的索引结构，每个索引（非聚集索引）互相之间不存在关联。<br />
每次给字段建一个新索引， 字段中的数据就会被复制一份出来， 用于生成索引。 因此， 给表添加索引，会增加表的体积， 占用磁盘存储空间。</p>
<p>查询非聚集索引和聚集索引的区别在于</p>
<ul>
<li>聚集索引：可以直接通过对应的平衡树查到需要查找的数据</li>
<li>非聚集索引 - 回表查询：首先通过聚集索引平衡树查到记录对应的主键值，再使用主键的值通过聚集索引平衡树查找到需要的数据</li>
</ul>
<p><img src="https://pic1.zhimg.com/v2-ef9b5d5d6407d80b937ca19d6be9dadc_b.jpg" alt="" /></p>
<p>不管以任何方式查询表， 最终都会利用主键通过聚集索引来定位到数据， 聚集索引（主键）是通往真实数据所在的唯一路径。</p>
<p>我们在建立索引之后，比如建立了 <code>birthday</code> 的索引，然后通过 <code>where birthday= ..</code> 来查询时：</p>
<ol>
<li>通过非聚集索引index_birthday查找birthday等于1991-11-1的所有记录的主键ID值</li>
<li>通过得到的主键ID值执行聚集索引查找，找到主键ID值对就的真实数据（数据行）存储的位置</li>
<li>从得到的真实数据中取得 select 字段的值返回</li>
</ol>
<p>B+Tree 对应两种搜索方式：</p>
<ol>
<li>Equality search：<code>Where age = 25</code>从根节点开始向下找，直到目标叶节点</li>
<li>Range query
<ul>
<li>[a, b]：<code>Where 20 &lt;= age and age &lt;= 30</code>，从根节点开始，向下找，先找到第一个满足条件的叶节点，然后向后顺序遍历，直到不符合要求。</li>
<li>[-, b]：<code>Where age &lt;= 30</code>，先找到左下角叶节点，然后遍历。</li>
<li>[a, -]：<code>Where 20 &lt;= age</code> 先找到左边第一个叶节点，然后遍历打最右边节点。</li>
</ul>
</li>
</ol>
<h1 id="数据结构"><a class="markdownIt-Anchor" href="#数据结构"></a> 数据结构</h1>
<h2 id="btree"><a class="markdownIt-Anchor" href="#btree"></a> B+Tree</h2>
<p>原始 B+Tree 的叶子节点组成一个单向链表，在 MySQL 中又为其添加了一个反向指针，叶子节点构成了一个双向闭环链表，来增加数据访问速度。<br />
内部节点存放的是索引，数据存放在叶子节点处。</p>
<p>max-Degree：一个节点的最大子节点个数，即指针的个数，key的数量为 指针数量-1 。</p>
<p>每个节点都是独立存放在单独的 页/block 中。</p>
<p>优势：</p>
<ol>
<li>每个内部节点对应的 block 不存放数据，进而可以存放更多键和指针，可以降低层数，检索效率高。</li>
<li>相较于 b树，叶子节点形成了链表，便于范围搜素和排序。</li>
<li>相较于 hash，hash 只支持等值匹配，不支持范围匹配和排序。</li>
</ol>
<h2 id="hash-index"><a class="markdownIt-Anchor" href="#hash-index"></a> Hash Index</h2>
<p>采用一定 hash 算法，将键值换算成为新的 hash 值，映射到 hash 表对应的槽位上。</p>
<p>只用于等值匹配，不支持范围查询。实现时，比如<code>where name='lyl'</code> ，先得到 <code>'lyl'</code> 的 hash 值，然后直接去hash表读取其地址，得到数据。</p>
<p>查询效率高，在没有 hash冲突 的情况下，只需要一次检索即可，一般比 B+Tree 查询要快。</p>
<h1 id="sql-性能分析"><a class="markdownIt-Anchor" href="#sql-性能分析"></a> SQL 性能分析</h1>
<ol>
<li>
<p>查询执行频次：<br />
<code>SHOW GLOBAL STATUS LIKE 'COM_______'</code> ：查看当前数据库增删改查的访问频次，四个命令正好都是六个字母，所以是1+6个下划线。</p>
</li>
<li>
<p>慢查询日志：用于定位哪些 sql 语句时间比较长<br />
慢查询日志记录了所有执行时间超过指定参数 (long_query_time， 单位：秒，默认10秒) 的所有SQL语句的日志。<br />
MySQL的慢查询日志默认没有开启，需要在MySQL的配置文件 <code>/etc/my.cnf</code> 中配置。</p>
<ul>
<li><code>show variables  like '%slow_query_log%';</code> 查看是否开启</li>
<li><code>show variables/global like 'long_query_time%';</code> 查看预设时间，variables是当前会话的，global是全局的（文件中的）。</li>
<li><code>show variables like 'slow_query_log_file';</code> 日志存放地址，可以通过 <code>tail -f</code> 命令实时查看</li>
<li><code>set global slow_query_log=1;</code> 开启，只对当前数据库生效，如果MySQL重启后则会失效。</li>
<li><code>set global long_query_time=4;</code> 设置时间，需要重新连接或新开一个会话才能看到修改值。</li>
<li><code>/etc/my.cnf</code> -&gt; <code>slow_query_log=1</code>，<code>long_query_time=10</code>，<code>slow_query_log_file=/tmp/mysql_slow.log</code> 永久开启</li>
</ul>
</li>
<li>
<p>MySQL提供了日志分析工具 <code>mysqldumpslow</code></p>
</li>
<li>
<p><code>show profile</code> 可以告诉我们操作耗时</p>
<ul>
<li>首先通过<code>SELECT @@have_profiling;</code> 查看是否支持该功能</li>
<li>如果关闭，则通过 <code>SET profiling=1;</code> 进行开启</li>
<li>查看每一条SOL的耗时: <code>show profiles;</code></li>
<li>查看指定 query_id 的SQL语句各个阶段的耗时情况 <code>show profile for query [query _id];</code></li>
<li>查看指定 query_id 的SQL语句CPU的使用情况: <code>show profile cpu for query [query id];</code></li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/03/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/CQL%20%E8%AF%AD%E8%A8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="A slow learner.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yili">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/03/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/CQL%20%E8%AF%AD%E8%A8%80/" class="post-title-link" itemprop="url">CQL 语言</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-03 18:41:24" itemprop="dateCreated datePublished" datetime="2021-03-03T18:41:24-08:00">2021-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>文档：<a target="_blank" rel="noopener" href="https://neo4j.com/docs/cypher-manual/current/clauses/">https://neo4j.com/docs/cypher-manual/current/clauses/</a></p>
<p>A Cypher query part can either read and match on the graph, or make updates on it, <strong>not both simultaneously.</strong></p>
<p>When performing <strong>Reading</strong> performance, Cypher will <strong>not match</strong> the pattern <strong>until</strong> you ask for the results.</p>
<p>In an updating query, all the <strong>reading</strong> will be <strong>firstly</strong> done totally, followed by all the <strong>writing</strong> performance.</p>
<p>These parts are separated by the statement <code>WITH</code>.<br />
<code>WITH</code> is like an event horizon — it’s <strong>a barrier</strong> between <strong>a plan</strong> and <strong>the finished execution</strong> of that plan.</p>
<p>Using <code>WITH</code>, you specify how you want the aggregation to happen, and that the aggregation has to be finished before Cypher can start filtering.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MATCH (n &#123;name: &#x27;John&#x27;&#125;)-[:FRIEND]-(friend)</span><br><span class="line">WITH n, count(friend) AS friendsCount</span><br><span class="line">WHERE friendsCount &gt; 3</span><br><span class="line">RETURN n, friendsCount</span><br></pre></td></tr></table></figure>
<h2 id="introduction-to-cypher"><a class="markdownIt-Anchor" href="#introduction-to-cypher"></a> Introduction to Cypher</h2>
<ul>
<li>Basic mode:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(nodes)-[:ARE_CONNECTED_TO]-&gt;(otherNodes)</span><br></pre></td></tr></table></figure>
<ul>
<li>rounded brackets <code>(nodes)</code> to include the node</li>
<li>arrow <code>-[:ARE_CONNECTED_TO]-&gt;</code> to declare the relationship</li>
</ul>
</li>
</ul>
<h3 id="nodes"><a class="markdownIt-Anchor" href="#nodes"></a> Nodes</h3>
<ul>
<li><strong>Nodes</strong> and <strong>relationships</strong> are the simple components of the <strong>pattern</strong>, which are the most valuable and powerful piece of the property graph model.</li>
</ul>
<br>
<ul>
<li>
<p>Cypher comments: <code>//</code></p>
</li>
<li>
<p>could use the nickname for a node like <code>(p)</code> for a person</p>
</li>
<li>
<p>also could use <code>()</code> for an anonymous node. This means that you are not be able to return this node later in the query.</p>
</li>
<li>
<p>assigning a node label, e.g. Person, Technology, and Company.<br />
It is like a class, and it likes we are telling the Cypher to only check those labels for that label.<br />
This helps Cypher distinguish between entities and optimize execution for your queries. It is always better to use node labels in your queries, where possible.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">()                  //anonymous node (no label or variable) can refer to any node in the database</span><br><span class="line">(p:Person)          //using variable p and label Person</span><br><span class="line">(:Technology)       //no variable, label Technology</span><br><span class="line">(work:Company)      //using variable work and label Company</span><br></pre></td></tr></table></figure>
<h3 id="relationships"><a class="markdownIt-Anchor" href="#relationships"></a> Relationships</h3>
<p>Directed relationships: <code>--&gt;</code>or <code>&lt;--</code> between two nodes<br />
Undirected relationships: <code>--</code> between two nodes</p>
<p>Additional information, such as <strong>relationship type</strong> and <strong>relationship properties</strong> could be added.</p>
<p>When using un-directional relationships <code>--</code> for query, Cypher would <strong>ignores any particular direction</strong> and <strong>retrieves the relationship and connected nodes</strong>, no matter what the physical direction is.<br />
In this case, user needn’t know the specific relationship.</p>
<p>But when using directional relationships <code>--&gt; / &lt;--</code> for query. The wrong direction will not return any results.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//data stored with this direction</span><br><span class="line">CREATE (p:Person)-[:LIKES]-&gt;(t:Technology)</span><br><span class="line"></span><br><span class="line">//query relationship backwards will not return results</span><br><span class="line">MATCH (p:Person)&lt;-[:LIKES]-(t:Technology)</span><br><span class="line"></span><br><span class="line">//better to query with undirected relationship unless sure of direction</span><br><span class="line">MATCH (p:Person)-[:LIKES]-(t:Technology)</span><br></pre></td></tr></table></figure>
<h3 id="node-or-relationship-properties"><a class="markdownIt-Anchor" href="#node-or-relationship-properties"></a> Node or relationship properties</h3>
<p>properties are <code>name-value</code> pairs</p>
<p>Node property: <code>(p:Person &#123;name: 'Sally'&#125;)</code><br />
Relationship property: <code>-[rel:IS_FRIENDS_WITH &#123;since: 2018&#125;]-&gt;</code></p>
<h3 id="patterns-in-cypher"><a class="markdownIt-Anchor" href="#patterns-in-cypher"></a> Patterns in Cypher</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(p:Person &#123;name: &quot;Sally&quot;&#125;)-[rel:LIKES]-&gt;(g:Technology &#123;type: &quot;Graphs&quot;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="patterns"><a class="markdownIt-Anchor" href="#patterns"></a> Patterns</h2>
<h3 id="node-syntax"><a class="markdownIt-Anchor" href="#node-syntax"></a> Node syntax</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">() // an anonymous, uncharacterized node</span><br><span class="line">(matrix) // every node with a variable</span><br><span class="line">(:Movie) // every node with a type/label</span><br><span class="line">(matrix:Movie)</span><br><span class="line">(matrix:Movie &#123;title: &#x27;The Matrix&#x27;&#125;) // every node with a property</span><br><span class="line">(matrix:Movie &#123;title: &#x27;The Matrix&#x27;, released: 1997&#125;)</span><br></pre></td></tr></table></figure>
<p>For the Type name, we are used to assign an all-upper-format; and if there is space, we use to use <code>_</code> in place of the blank.<br />
For the property value, if it is a char type, we should use quotation marks <code>' / &quot;</code> around it.</p>
<h3 id="relationship-syntax"><a class="markdownIt-Anchor" href="#relationship-syntax"></a> Relationship syntax</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--&gt;</span><br><span class="line">-[role]-&gt;  // variable</span><br><span class="line">-[:ACTED_IN]-&gt; // type/label</span><br><span class="line">-[role:ACTED_IN]-&gt;</span><br><span class="line">-[role:ACTED_IN &#123;roles: [&#x27;Neo&#x27;]&#125;]-&gt;</span><br></pre></td></tr></table></figure>
<h3 id="pattern-syntax"><a class="markdownIt-Anchor" href="#pattern-syntax"></a> Pattern syntax</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(keanu:Person:Actor &#123;name: &#x27;Keanu Reeves&#x27;&#125;)</span><br><span class="line">    -[role:ACTED_IN &#123;roles: [&#x27;Neo&#x27;]&#125;]-&gt;</span><br><span class="line">    (matrix:Movie &#123;title: &#x27;The Matrix&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="pattern-variables"><a class="markdownIt-Anchor" href="#pattern-variables"></a> Pattern variables</h3>
<p>Cypher allows patterns to be assigned to variables.<br />
This allows the matching paths to be inspected, used in other expressions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acted_in = (:Person)-[:ACTED_IN]-&gt;(:Movie)</span><br></pre></td></tr></table></figure>
<p>Then, this variable would contain the matched paths (2 nodes and 1 relationship).<br />
Later we could use a number of functions to access details of a path, like <code>nodes(path)</code>, <code>relationships(path)</code>, and <code>length(path)</code>.</p>
<h3 id="clauses"><a class="markdownIt-Anchor" href="#clauses"></a> Clauses</h3>
<p>There are multiple clauses, each performs a specific task.<br />
like:</p>
<ul>
<li>create and match patterns in the graph</li>
<li>filter, project, sort, or paginate results</li>
<li>compose partial statements</li>
</ul>
<h2 id="patterns-in-practice"><a class="markdownIt-Anchor" href="#patterns-in-practice"></a> Patterns in practice</h2>
<h3 id="creating-and-returning-data"><a class="markdownIt-Anchor" href="#creating-and-returning-data"></a> Creating and Returning data</h3>
<h4 id="create"><a class="markdownIt-Anchor" href="#create"></a> CREATE</h4>
<p>The simplest clause is called <code>CREATE</code>. It creates the patterns (nodes and relationship) that you specify.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE (:Movie &#123;title: &#x27;The Matrix&#x27;, released: 1997&#125;)</span><br></pre></td></tr></table></figure>
<p>After running this statement, Cypher returns <strong>the number of changes</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Created Nodes: 1</span><br><span class="line">Added Labels: 1</span><br><span class="line">Set Properties: 2</span><br><span class="line">Rows: 0</span><br></pre></td></tr></table></figure>
<h3 id="return"><a class="markdownIt-Anchor" href="#return"></a> RETURN</h3>
<p>to return the created data</p>
<p>The <code>RETURN</code> clause in Cypher specifies <strong>what values or results</strong> to return from a Cypher query:</p>
<ul>
<li>node</li>
<li>relationships</li>
<li>node and relationship properties</li>
<li>patterns</li>
</ul>
<p><code>RETURN</code> is not required when doing write procedures, but <strong>is needed for reads</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE (a:Person &#123;name: &#x27;Tom Hanks&#x27;, born: 1956&#125;)-[r:ACTED_IN &#123;roles: [&#x27;Forrest&#x27;]&#125;]-&gt;(m:Movie &#123;title: &#x27;Forrest Gump&#x27;, released: 1994&#125;)</span><br><span class="line">CREATE (d:Person &#123;name: &#x27;Robert Zemeckis&#x27;, born: 1951&#125;)-[:DIRECTED]-&gt;(m)</span><br><span class="line">RETURN a, d, r, m</span><br></pre></td></tr></table></figure>
<h3 id="matching-patterns"><a class="markdownIt-Anchor" href="#matching-patterns"></a> Matching patterns</h3>
<p>assign the pattern to <code>MATCH</code> to describe what you are looking for.</p>
<p>A <code>MATCH</code> statement searches for the patterns you specify and return one row per successful pattern match.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// all nodes labeled with the Movie label.</span><br><span class="line">MATCH (m:Movie)</span><br><span class="line">RETURN m</span><br><span class="line"></span><br><span class="line">// look for a specific person, like Keanu Reeves.</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Keanu Reeves&#x27;&#125;)</span><br><span class="line">RETURN p</span><br><span class="line"></span><br><span class="line">// the movies&#x27; titles that Tom Hanks acted in and roles he played.</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Tom Hanks&#x27;&#125;)-[r:ACTED_IN]-&gt;(m:Movie)</span><br><span class="line">RETURN m.title, r.roles</span><br></pre></td></tr></table></figure>
<h3 id="aliasing-return-values"><a class="markdownIt-Anchor" href="#aliasing-return-values"></a> Aliasing return values</h3>
<p>Sometimes the return name or property is complex, so we could also alias the property with a cleaner name using <code>AS</code> at the <code>RETURN</code> line.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MATCH (tom:Person &#123;name:&#x27;Tom Hanks&#x27;&#125;)-[rel:DIRECTED]-(movie:Movie)</span><br><span class="line">RETURN tom.name AS name, tom.born AS `Year Born`, movie.title AS title, movie.released AS `Year Released`</span><br></pre></td></tr></table></figure>
<p>If there is a space in the nickname, we should use the backtick character `.<br />
And if there is a space in in the Type name, or property value, we could use <code>''</code>.</p>
<h2 id="attaching-structure"><a class="markdownIt-Anchor" href="#attaching-structure"></a> Attaching structure</h2>
<p>extend the graph based on some existing nodes:</p>
<ol>
<li>first <code>MATCH</code> the existing connection points</li>
<li>attach the newly created nodes with relationships using <code>CREATE</code></li>
</ol>
<p>It is also possible to <code>CREATE</code> a node and a relationship simultaneously, but we’d better <code>CREATE</code> one by one for better readability.</p>
<blockquote>
<p>If the <code>MATCH</code> command return many rows, we could move <code>CREATE</code> before the <code>MATCH</code> line, so that it needn’t create new node for each line.</p>
</blockquote>
<h2 id="completing-patterns"><a class="markdownIt-Anchor" href="#completing-patterns"></a> Completing patterns</h2>
<p>Sometimes when we do <code>CREATE</code> command, we are not sure whether the node/relationship has existed.</p>
<p>In this case, we could use <code>MERGE</code> command to express a repeatable update operation.</p>
<p>It would check for the existence of the data before <code>CREATE</code>. Also we could <strong>add</strong> some properties using the <code>ON CREATE</code>.<br />
But <code>ON CREATE SET</code> <strong>could only add a property</strong>, if the property has existed, <strong>no changing</strong> would be performed.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MERGE (m:Movie &#123;title: &#x27;Cloud Atlas&#x27;&#125;)</span><br><span class="line">ON CREATE SET m.released = 2012</span><br><span class="line">RETURN m</span><br></pre></td></tr></table></figure>
<p>It comes with large cost check for existing matches first, especially on large graphs. So if we are sure to <strong>not create duplicate</strong> data use <code>CREATE</code> over <code>MERGE</code>.</p>
<p>Also, <code>MERGE</code> works for relationships:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MATCH (m:Movie &#123;title: &#x27;Cloud Atlas&#x27;&#125;)</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Tom Hanks&#x27;&#125;)</span><br><span class="line">MERGE (p)-[r:ACTED_IN]-&gt;(m)</span><br><span class="line">ON CREATE SET r.roles =[&#x27;Zachry&#x27;]</span><br><span class="line">RETURN p, r, m</span><br></pre></td></tr></table></figure>
<p>if the relationship direction is arbitrary, we could use <code>-[r:ACTED_IN]-</code>.</p>
<p>If we only pass one node for <code>MERGE</code> in a relationship, it would <code>CREATE</code> both the relationship and the other node.</p>
<h2 id="getting-the-correct-results"><a class="markdownIt-Anchor" href="#getting-the-correct-results"></a> Getting the correct results</h2>
<h3 id="filtering-results"><a class="markdownIt-Anchor" href="#filtering-results"></a> Filtering results</h3>
<p>After <code>MATCH</code>, using <code>WHERE</code> clause to use any number of boolean expressions, predicates, combined with <code>AND</code>, <code>OR</code>, <code>XOR</code> and <code>NOT</code>.</p>
<p>Actually it is equivalent to the query with the condition in the pattern.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MATCH (m:Movie)</span><br><span class="line">WHERE m.title = &#x27;The Matrix&#x27;</span><br><span class="line">RETURN m</span><br><span class="line"></span><br><span class="line">==</span><br><span class="line">MATCH (m:Movie &#123;title: &#x27;The Matrix&#x27;&#125;)</span><br><span class="line">RETURN m</span><br></pre></td></tr></table></figure>
<p>There are optional conditions:</p>
<ol>
<li>property matching: <code>node.property_key = &quot;value&quot;</code></li>
<li>numeric comparisons: <code>node.property_key &gt;&lt;= int</code></li>
<li>matching regular expressions: <code>p.name =~ 'K.+'</code></li>
<li>the existence of values within a list: <code>&quot;target_str&quot; IN node.property_key</code></li>
<li>a pattern predicate restricts:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p:Person)-[:ACTED_IN]-&gt;(m)</span><br><span class="line">WHERE NOT (p)-[:DIRECTED]-&gt;()  // has never directed any movies</span><br><span class="line">RETURN p, m</span><br></pre></td></tr></table></figure>
<h4 id="querying-ranges-of-values"><a class="markdownIt-Anchor" href="#querying-ranges-of-values"></a> Querying ranges of values</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p:Person)</span><br><span class="line">WHERE 3 &lt;= p.yearsExp &lt;= 7</span><br><span class="line">RETURN p</span><br></pre></td></tr></table></figure>
<h4 id="testing-if-a-property-exists"><a class="markdownIt-Anchor" href="#testing-if-a-property-exists"></a> Testing if a property exists</h4>
<p>In Neo4j, a property <strong>only exists (is stored) if it has a value</strong>. A null property is not stored.<br />
we could use <code>IS NOT NULL</code> for these nodes with the property.</p>
<h4 id="checking-strings-partial-values-fuzzy-searches"><a class="markdownIt-Anchor" href="#checking-strings-partial-values-fuzzy-searches"></a> Checking strings — partial values, fuzzy searches</h4>
<p><code>p.name STARTS WITH 'M'</code><br />
<code>p.name CONTAINS 'a'</code><br />
<code>p.name ENDS WITH 'n'</code></p>
<p>use regular expressions: <code>WHERE p.name =~ 'Jo.*'</code></p>
<h4 id="in-a-list"><a class="markdownIt-Anchor" href="#in-a-list"></a> in a list</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHERE p.yearsExp IN [1, 5, 6]</span><br></pre></td></tr></table></figure>
<h4 id="filtering-on-patterns-inner-join"><a class="markdownIt-Anchor" href="#filtering-on-patterns-inner-join"></a> Filtering on patterns ( Inner join )</h4>
<p>can also filter results based on relationships or patterns</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//Query1: find which people are friends of someone who works for Neo4j</span><br><span class="line">MATCH (p:Person)-[r:IS_FRIENDS_WITH]-&gt;(friend:Person)</span><br><span class="line">WHERE exists((p)-[:WORKS_FOR]-&gt;(:Company &#123;name: &#x27;Neo4j&#x27;&#125;))</span><br><span class="line">RETURN p, r, friend;</span><br><span class="line"></span><br><span class="line">//Query2: find Jennifer&#x27;s friends who do not work for a company</span><br><span class="line">MATCH (p:Person)-[r:IS_FRIENDS_WITH]-&gt;(friend:Person)</span><br><span class="line">WHERE p.name = &#x27;Jennifer&#x27;</span><br><span class="line">AND NOT exists((friend)-[:WORKS_FOR]-&gt;(:Company))</span><br><span class="line">RETURN friend.name;</span><br></pre></td></tr></table></figure>
<h4 id="optional-patterns-outre-join"><a class="markdownIt-Anchor" href="#optional-patterns-outre-join"></a> Optional patterns( Outre join )</h4>
<p>In Cypher, you can use an <code>OPTIONAL MATCH</code> pattern to try to match it, but if it doesn’t find results, those rows will return null for those values.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//Find all people whose name starts with J and who may work for a company.</span><br><span class="line">MATCH (p:Person)</span><br><span class="line">WHERE p.name STARTS WITH &#x27;J&#x27;</span><br><span class="line">OPTIONAL MATCH (p)-[:WORKS_FOR]-(other:Company)</span><br><span class="line">RETURN p.name, other.name;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">+--------------------------------+</span><br><span class="line">| p.name      | other.name       |</span><br><span class="line">+--------------------------------+</span><br><span class="line">| &#x27;Jennifer&#x27;  | &#x27;Neo4j&#x27;          |</span><br><span class="line">| &#x27;John&#x27;      | &#x27;XYZ&#x27;            |</span><br><span class="line">| &#x27;Joe&#x27;       | null             |</span><br><span class="line">+--------------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="more-complex-patterns"><a class="markdownIt-Anchor" href="#more-complex-patterns"></a> More complex patterns</h4>
<p>we could expand our pattern to perform more complex relationships:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//Query2: find who likes graphs besides Jennifer that she is also friends with</span><br><span class="line">MATCH (j:Person &#123;name: &#x27;Jennifer&#x27;&#125;)-[:LIKES]-&gt;(:Technology &#123;type: &#x27;Graphs&#x27;&#125;)&lt;-[:LIKES]-(p:Person),</span><br><span class="line">      (j)-[:IS_FRIENDS_WITH]-(p)</span><br><span class="line">RETURN p.name;</span><br></pre></td></tr></table></figure>
<p>Also, we could use <code>,</code> to use multiple conditional patterns. It is also a good way to replace <code>WHERE exists(&lt;pattern&gt;)</code>.</p>
<h3 id="returning-results"><a class="markdownIt-Anchor" href="#returning-results"></a> Returning results</h3>
<p>after <code>RETURN</code>,  we could add some simple expressions to operate the returned value:</p>
<ol>
<li>index: <code>names[0]</code>, <code>movies[1..-1]</code>, <code>substring('2014-07-01', 0, 4)</code></li>
<li>length(array)</li>
<li>toInteger(‘12’)</li>
<li>coalesce(p.nickname, ‘n/a’)</li>
</ol>
<p><code>UNIQUE</code> could trim out duplicate entities.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//Query: find people who have a twitter or like graphs or query languages</span><br><span class="line">MATCH (user:Person)</span><br><span class="line">WHERE user.twitter IS NOT null</span><br><span class="line">WITH user</span><br><span class="line">MATCH (user)-[:LIKES]-(t:Technology)</span><br><span class="line">WHERE t.type IN [&#x27;Graphs&#x27;,&#x27;Query Languages&#x27;]</span><br><span class="line">RETURN DISTINCT user.name</span><br></pre></td></tr></table></figure>
<h4 id="limiting-number-of-results"><a class="markdownIt-Anchor" href="#limiting-number-of-results"></a> Limiting number of results</h4>
<p><code>LIMIT</code> keyword takes the output of the query and limits the volume returned based on the number you specify.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//Query: find the top 3 people who have the most friends</span><br><span class="line">MATCH (p:Person)-[r:IS_FRIENDS_WITH]-(other:Person)</span><br><span class="line">RETURN p.name, count(other.name) AS numberOfFriends</span><br><span class="line">ORDER BY numberOfFriends DESC</span><br><span class="line">LIMIT 3</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://neo4j.com/docs/getting-started/current/cypher-intro/results/#cypher-intro-results-aggregating">https://neo4j.com/docs/getting-started/current/cypher-intro/results/#cypher-intro-results-aggregating</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/34/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><span class="page-number current">35</span><a class="page-number" href="/page/36/">36</a><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/36/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">A slow learner.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">366</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/YiandLi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;YiandLi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/yiliiiii" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yiliiiii" rel="noopener" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">629k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">69:53</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
